
<div class="layui-row">
        <div class="layui-col-md2">
            <form class="layui-form">
                <div id="roletree" style="height:800px;border:0px;overflow:auto;">
                </div>
            </form>
        </div>
        <div class="layui-col-md10">
            <blockquote class="layui-elem-quote news_search">
                <div class="layui-inline">
                    <div class="layui-input-inline layui-form">
                        <select id="page_sysid" name="page_sysid" lay-filter="sysSelect">
                            <option value="" ></option>
                        </select>
                    </div>
                </div>
                <div class="layui-inline">
                    <div class="layui-input-inline">
                        <input type="text" value="" placeholder="请输入角色名称/编码" class="layui-input search_input">
                    </div>
                    <a class="layui-btn layui-btn-primary search_btn"><i class="layui-icon">&#xe615;</i>查询</a>
                </div>
                <div class="layui-inline">

                    <a class="layui-btn layui-btn-primary rest_btn"><i class="layui-icon">&#xe65c;</i>重置</a>
                </div>
                <div class="layui-inline">
                    <a class="layui-btn layui-btn-primary roleAdd_btn"><i class="layui-icon">&#xe654;</i>新增</a>

                </div>
                <div class="layui-inline">
                    <a class="layui-btn layui-btn-primary roleEdit_btn"><i class="layui-icon">&#xe642;</i>修改</a>

                </div>
                <div class="layui-inline">
                    <a class="layui-btn layui-btn-primary toAuthority_btn"><i class="layui-icon">&#xe620;</i>授权</a>

                </div>
                <div class="layui-inline">
                    <div class="layui-form-mid layui-word-aux"></div>
                </div>
            </blockquote>
            <div class="layui-form news_list">
                <table class="layui-hide" id="datagrid" lay-data="{id: 'datagrid'}" lay-filter="roleTableFilter"></table>
            </div>
        </div>
    </div>


<!--引入xtree-->
<script type="text/javascript" src="static/js/xtree/layui-xtree.js"></script>
<!--addmodel-->
<div id="role_model" class="page_model" style="display:none;">
    <div class="layui-show">
        <div class="layui-form layui-form-pane">
            <form id="role_form" method="post" style="padding: 5px; line-height: 5px;">

                <div class="layui-form-item ">
                    <label  class="layui-form-label" >角色编码<span style="color: red">*</span></label>
                    <div class="layui-input-block">
                        <input type="text" id="role_code" name="role_code" required lay-verify="required" autocomplete="off" placeholder="角色编码" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item ">
                    <label  class="layui-form-label" >角色名<span style="color: red">*</span></label>
                    <div class="layui-input-block">
                        <input type="text" id="role_name" name="role_name" required lay-verify="required" autocomplete="off" placeholder="角色名" class="layui-input">
                    </div>
                </div>

                <div class="layui-form-item ">
                    <label  class="layui-form-label" >所属系统</label>
                    <div class="layui-input-block">
                        <select id="sys_id" name="sys_id">
                            <option value="" ></option>
                        </select>
                    </div>
                </div>
                <div class="layui-form-item ">
                    <label class="layui-form-label" >角色状态</label>
                    <div class="layui-input-block">
                        <select id="role_status" name="role_status">
                            <option value="1" selected>正常</option>
                            <option value="0" >禁用</option>
                        </select>
                    </div>
                </div>
                <div class="layui-form-item ">
                    <label  class="layui-form-label" >排序号</label>
                    <div class="layui-input-block">
                        <input type="number" id="role_order" name="role_order" autocomplete="off" value="1" class="layui-input" >
                    </div>
                </div>

                <div class="layui-form-item layui-form-text">
                    <label class="layui-form-label" >角色备注</label>
                    <div class="layui-input-block">
                        <textarea id="role_remark" name="role_remark" placeholder="请输入角色备注" class="layui-textarea" rows="2"></textarea>
                    </div>
                </div>
                <div class="layui-form-item page-form-btn">
                    <button class="layui-btn" id="form_submit_btn" lay-filter="form_submit_btn" lay-submit>确定</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script type="text/html" id="statusTpl">
    {{#out '{{d.role_status == 1 ? "正常" : "禁用"}}'}}{{/out}}
</script>
<script>

    layui.use(['table','form','jquery','tree','layer'], function(){
        var table = layui.table;
        var form = layui.form;
        var $ = layui.$;
        var layer=layui.layer;
        var currentSysId;
        var currentSysName;

        //获取菜单树形目录
        var xtree;

        //系统列表初始化
        $.ajax({
            url:'{{projcfg.base}}/common/syslist.do',
            type:'get',
            success:function (res) {
                $('#page_sysid').html('');
                var items=res.data;
                for(var i in items){
                    $('#page_sysid').append('<option value =\"' + items[i].id + '\">' + items[i].sys_name + '</option>');
                    form.render('select');
                }
                $('#page_sysid').get(0).selectedIndex=0;
                //获取系统id的菜单
                var sys_id=$('#page_sysid').val();
                var sys_name=$('#page_sysid').find("option:selected").text();

                currentSysId=sys_id;
                currentSysName=sys_name;

                //表格切换
                table.reload('datagrid',{
                    url: '{{projcfg.base}}/role/switchsys.do',
                    where:{sys_id:sys_id}
                });

                //菜单树形目录初始化
                $.ajax({
                    url:'{{projcfg.base}}/role/roletree.do',
                    type:'get',
                    data:{'sysname':sys_name,'sysid':sys_id},
                    success:function (res) {
                        xtree=new layuiXtree({
                            elem:'roletree',
                            form:form,
                            data:JSON.parse(res.data),
                        });
                    }
                });
            }
        });

        //系统切换
        form.on('select(sysSelect)',function (data) {
           var sys_id=data.value;
           var sys_name=$('#page_sysid').find("option:selected").text();
            currentSysId=sys_id;
            currentSysName=sys_name;
            refresh(sys_id,sys_name);

        });
        
        function refresh(sys_id,sys_name) {
            //表格切换
            table.reload('datagrid',{
                url: '{{projcfg.base}}/role/switchsys.do',
                where:{sys_id:sys_id}
            });

            //菜单切换
            $.ajax({
                url:'{{projcfg.base}}/role/roletree.do',
                type:'get',
                data:{'sysname':sys_name,'sysid':sys_id},
                success:function (res) {
                    xtree=new layuiXtree({
                        elem:'roletree',
                        form:form,
                        data:JSON.parse(res.data),
                    });
                }
            });
        }
        
        table.render({
            elem: '#datagrid'
            ,id: 'datagrid'
            ,url:'{{projcfg.base}}/role/list.do'
            ,height: '{{projcfg.page_config.height}}'
            //,cellMinWidth: 10 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
            ,cols: [[
                {type:'numbers'},
                {type:'checkbox'},
                {field:'role_code', title: '角色编码',width:200,align:'left'}
                ,{field:'role_name', title: '角色名称',width:200,align:'left'}
                ,{field:'role_order', title: '排序号',width:80,align:'left',sort:true}
                ,{field:'role_status', title: '状态',width:60,toolbar: '#statusTpl',align:'left'}
                ,{field:'role_remark', title: '备注',align:'left'}
            ]]
            ,page: true
            ,done: function(res, curr, count) {
                signleSelect($, 'datagrid');
            }

        });

        //获取系统列表
        $.ajax({
            url:'{{projcfg.base}}/common/syslist.do',
            type:'get',
            success:function (res) {
                $('#sys_id').html('');
                var items=res.data;
                for(var i in items){
                    $('#sys_id').append('<option value =\"' + items[i].id + '\">' + items[i].sys_name + '</option>');
                    form.render('select');
                }
                $('#sys_id').get(0).selectedIndex=0;
            }
        });

        //角色列表复选框事件
        table.on('checkbox(roleTableFilter)',function (obj) {
            var role_data=obj.data;
            var checkStatus=table.checkStatus('datagrid');
            if(obj.checked){//选中更新树的选中情况
                $.ajax({
                    url:'{{projcfg.base}}/role/updateroletree.do',
                    type:'get',
                    data:{'roleid':role_data.id,'sysid':currentSysId,'sysname':currentSysName},
                    success:function (res) {
                        xtree=new layuiXtree({
                            elem:'roletree',
                            form:form,
                            data:JSON.parse(res.data),
                        });
                    }
                });
            }else{
                //菜单切换
                $.ajax({
                    url:'{{projcfg.base}}/role/roletree.do',
                    type:'get',
                    data:{'sysname':currentSysName,'sysid':currentSysId},
                    success:function (res) {
                        xtree=new layuiXtree({
                            elem:'roletree',
                            form:form,
                            data:JSON.parse(res.data),
                        });
                    }
                });

            }
            /*
            if(checkStatus.data.length > 1){
                layer.msg("请选择一个角色。", {icon: 5});
            }else{

            }*/
        })


        //监听锁定操作
        form.on('checkbox(lock)', function(obj){
            console.log(obj);
            layer.tips(this.value + ' ' + this.name + '：'+ obj.elem.checked, obj.othis);
            var account_status='';

            var account_name= this.value;
            if(obj.elem.checked){
                account_status = 2;
            }else {
                account_status = 1;
            }
            var loading = layer.load(1);
            // alert(user_status);
            $.ajax({
                url: "{{projcfg.base}}/admin/lock.json",
                data: {account_name:account_name,account_status:account_status},
                method: 'POST',
                success: function (res) {

                    if (res.success) {
                        layer.close(loading);
                        layer.msg(res.msg, {icon: 6, time: 2000}, function () {

                        });
                    }
                    else {
                        layer.close(loading);
                        layer.msg(res.msg, {icon: 5});
                    }
                },
                error: function () {
                    layer.close(loading);
                    layer.msg("设置账号禁用状态失败", {icon: 5});
                }
            });
        });
        

        //新增role
        $(".roleAdd_btn").click(function(){

            openLayer(layui.layer, {
                title: '新增角色',     //显示标题
                area: ['600px', '485px'], //宽高
                content:  $('#role_model'),
                success: function(layero, index){
                    form.render();


                    //监听提交
                    form.on('submit(form_submit_btn)', function(data){
                        var loading = layer.load(1);
                        $.ajax({
                            url: "{{projcfg.base}}/role/save.do",
                            data: data.field, //请求的附加参数，用json对象
                            method: 'POST',
                            success: function (res) {
                                if(res.success) {
                                    layer.close(loading);
                                    layer.closeAll();
                                    layer.msg(res.msg, { icon: 6, time: 2000 }, function () {
                                        var sys_id=$('#sys_id').val();
                                        var sys_name=$('#sys_id').find("option:selected").text();
                                        $('#page_sysid').val(sys_id);
                                        form.render('select');
                                        refresh(sys_id,sys_name);
                                        clear(data.field);
                                    });
                                }
                                else {
                                    layer.close(loading);
                                    layer.msg(res.msg, { icon: 5 });
                                }
                            },
                            error: function () {
                                layer.close(loading);
                                layer.msg("新建角色失败", { icon: 5 });
                            }
                        });

                        return false;
                    });
                }
            }, '#form_submit_btn');
        });

        //edit role
        $(".roleEdit_btn").click(function () {
            /*$('#add_btn').hide();
            $('#edit_btn').show();*/
            var checkStatus = table.checkStatus('datagrid');
            if (checkStatus.data.length != 1) {
                layer.msg("请选择一条数据。", {icon: 5});
            }else{
                var roledata=checkStatus.data;

                openLayer(layui.layer, {
                    title: '修改角色',
                    area: ['600px', '485px'], //宽高
                    content: $('#role_model'),
                    btn2: function(index, layero){
                        clear(roledata[0]);
                        layer.close(index);
                    },
                    cancel: function (index, layero) {
                        clear(roledata[0]);
                        layer.close(index);
                    },
                    // 窗口加载成功后调用
                    success: function(layero, index) {

                        getData(roledata[0]);
                        form.on('submit(form_submit_btn)',function (data) {
                            data.field.role_id=roledata[0].id;
                            var loading=layer.load(1);
                            $.ajax({
                                url: "{{projcfg.base}}/role/modify.do",
                                data: data.field, //请求的附加参数，用json对象
                                method: 'POST',
                                success:function (res) {
                                    if(res.success) {
                                        layer.close(loading);
                                        layer.closeAll();
                                        layer.msg(res.msg, { icon: 6, time: 2000 }, function () {
                                            var sys_id=$('#sys_id').val();
                                            var sys_name=$('#sys_id').find("option:selected").text();
                                            $('#page_sysid').val(sys_id);
                                            form.render('select');
                                            refresh(sys_id,sys_name);
                                            clear(roledata[0]);
                                        });
                                    }
                                    else {
                                        layer.close(loading);
                                        layer.msg(res.msg, { icon: 5 });
                                    }
                                },
                                error: function () {
                                    layer.close(loading);
                                    layer.msg("修改角色信息失败", { icon: 5 });
                                }
                            });
                            return false;
                        });
                    }
                }, '#form_submit_btn');
            }
        });

        //追踪叶子到根节点的目录
        function getOptList(list,value) {
            list.push(value);
            if(xtree.GetParent(value)&&xtree.GetParent(value).value==1){
                return list
            }else{
                getOptList(list,xtree.GetParent(value).value);
            }
        }
        //设置权限
        $(".toAuthority_btn").click(function () {
            var checkStatus = table.checkStatus('datagrid');
            if (checkStatus.data.length != 1) {
                layer.msg("请选择一条数据。", {icon: 5});
            }else{
                var roledata=checkStatus.data;
                var checkNode=xtree.GetChecked();
                var leaf=[];
                var role_opt_list=[];
                for(var i in checkNode){
                    leaf.push(checkNode[i].value);
                }

                for(var i in leaf){
                    getOptList(role_opt_list,leaf[i]);
                }

                var role_opt_set=new Set(role_opt_list);

                var sendData=[];
                for(var s of role_opt_set){
                    sendData.push(s);
                }

                var loading=layer.load(1);

                $.ajax({
                    url: "{{projcfg.base}}/role/saveRoleOpt.do",
                    data: {'roleid':roledata[0].id,'optlist':sendData,'sysid':currentSysId}, //请求的附加参数，用json对象
                    method: 'POST',
                    success: function (res) {
                        if(res.success) {
                            layer.close(loading);
                            layer.closeAll();
                            layer.msg(res.msg, { icon: 6, time: 2000 }, function () {
                                // location.reload();
                            });
                        }
                        else {
                            layer.close(loading);
                            layer.msg(res.msg, { icon: 5 });
                        }
                    },
                    error: function () {
                        layer.close(loading);
                        layer.msg("授权失败", { icon: 5 });
                    }
                });

            }
        });
        //修改角色信息弹窗回填
        function getData(data) {
            for(var k in data){
                $('#'+k).val(data[k]);
            }
            form.render();
        }

        //清空表单
        function clear(data) {
            for(var k in data){
                $('#'+k).val('');
            }
            form.render();
        }

        //查询
        $(".search_btn").click(function(){

            var role_name = $(".search_input").val();
            if($(".search_input").val() != ''){

                table.reload('datagrid',{
                    where: { //设定异步数据接口的额外参数，任意设
                        role_name:role_name
                    },
                    page: {
                        curr: 1 //重新从第 1 页开始
                    }
                });
            }else{
                layer.msg("请输入需要查询的内容");
            }
        })
        //重置
        $(".rest_btn").click(function(){

            $(".search_input").val("");
            table.reload('datagrid',{
                where: { //设定异步数据接口的额外参数，任意设
                    role_name:'',
                },
                page: {
                    curr: 1 //重新从第 1 页开始
                }
            });
        })
    });


</script>