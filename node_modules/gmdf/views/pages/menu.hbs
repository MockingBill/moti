<div class="layui-row">
        <div class="layui-col-md2">
            <div style="overflow:auto;height:800px;">
                <ul id="menutree" lay-filter="menutreefilter"></ul>
            </div>
        </div>
        <div class="layui-col-md10">
            <blockquote class="layui-elem-quote news_search">
                <div class="layui-inline">
                    <div class="layui-input-inline layui-form">
                        <select id="page_menu_sysid" name="page_menu_sysid" lay-filter="sysSelect">
                            <option value="" ></option>
                        </select>
                    </div>
                </div>
            <div class="layui-inline">
                <div class="layui-input-inline">
                    <input type="text" value="" placeholder="请输入菜单名称/编码" class="layui-input search_input">
                </div>
                <a class="layui-btn layui-btn-primary search_btn"><i class="layui-icon">&#xe615;</i>查询</a>
            </div>
            <div class="layui-inline">

                <a class="layui-btn layui-btn-primary rest_btn"><i class="layui-icon">&#xe65c;</i>重置</a>
            </div>
            <div class="layui-inline">
                <a class="layui-btn layui-btn-primary newsAdd_btn"><i class="layui-icon">&#xe654;</i>新增</a>
            </div>
            <div class="layui-inline">
                <a class="layui-btn layui-btn-primary menuEdit_btn"><i class="layui-icon">&#xe642;</i>修改</a>
            </div>

            <div class="layui-inline">
                <div class="layui-form-mid layui-word-aux"></div>
            </div>
        </blockquote>
            <div class="layui-form news_list">
                <table class="layui-hide" id="datagrid" lay-size="sm" lay-data="{id: 'datagrid'}" lay-filter="TableFilter"></table>
            </div>
        </div>
    </div>

<!--addmodel-->
<div id="menu_model" class="page_model" style="display:none;">
    <div class="layui-show">
        <div class="layui-form layui-form-pane">
            <form id="menu_form" method="post" style="padding: 5px; line-height: 5px;">
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label  class="layui-form-label" >所属系统</label>
                        <div class="layui-input-inline">
                            <select id="menu_sysid" name="menu_sysid" lay-filter="pMenuSwitch">
                                <option value="" ></option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label"><a href="javascript:test2();">上级菜单</a><span style="color:red">*</span></label>
                        <div class="layui-input-inline">
                            <div class="layui-unselect layui-form-select downpanel" >
                                <div class="layui-select-title" onclick="openSelectTree()">
                                    <span class="layui-input layui-unselect" id="treeclass" ></span>
                                    <input type="hidden" name="menu_pid" id="menu_pid">
                                    <i class="layui-edge"></i>
                                </div>
                                <dl class="layui-anim layui-anim-upbit">
                                    <dd>
                                        <ul id="menuselecttree"></ul>
                                    </dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label  class="layui-form-label" >菜单编码<span style="color: red">*</span></label>
                        <div class="layui-input-inline">
                            <input type="text" id="menu_code" name="menu_code" required lay-verify="required" autocomplete="off" placeholder="菜单编码" class="layui-input" >
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label  class="layui-form-label" >菜单名称<span style="color: red">*</span></label>
                        <div class="layui-input-inline">
                            <input type="text" id="menu_name" name="menu_name" required lay-verify="required" autocomplete="off" placeholder="菜单名称" class="layui-input" >
                        </div>
                    </div>
                </div>

                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label  class="layui-form-label">图标样式</label>
                        <div class="layui-input-inline">
                            <input type="text" id="menu_cls" name="menu_cls" autocomplete="off" placeholder="菜单图标样式" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label  class="layui-form-label">打开方式</label>
                        <div class="layui-input-inline">
                           <!-- <input type="text" id="menu_target" name="menu_target" autocomplete="off"  value="_self" class="layui-input" > -->
                            <select id="menu_target" name="menu_target" autocomplete="off">
                                <option value="single">单页</option>
                                <option value="iframe">iframe</option>
                                <option value="blank">新窗口</option>
                            </select>
                        </div>
                    </div>
                </div>


                <div class="layui-form-item ">
                    <label class="layui-form-label" >菜单url<span style="color: red">*</span></label>
                    <div class="layui-input-block">
                        <input type="text" id="menu_url" name="menu_url" required lay-verify="required" autocomplete="off" placeholder="菜单url" class="layui-input">
                    </div>
                </div>

                <div class="layui-form-item ">
                    <label class="layui-form-label" >菜单导航<span style="color: red">*</span></label>
                    <div class="layui-input-block">
                        <input type="text" id="menu_nav" name="menu_nav" required lay-verify="required" autocomplete="off" placeholder="菜单导航" class="layui-input">
                    </div>
                </div>

                <div class="layui-form-item " style="display: none">
                    <label  class="layui-form-label">路由名称</label>
                    <div class="layui-input-inline">
                        <input type="text" id="menu_spt" name="menu_spt" autocomplete="off" placeholder="路由脚本名称" class="layui-input" >
                    </div>
                </div>

                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label  class="layui-form-label" >排序号</label>
                        <div class="layui-input-inline">
                            <input type="number" id="menu_order" name="menu_order" autocomplete="off" value="1" class="layui-input" >
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label  class="layui-form-label" >菜单层级</label>
                        <div class="layui-input-inline" >
                            <select id="menu_level" name="menu_level">
                                <option value="1" selected>导航</option>
                                <option value="2" >菜单</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label" >状态</label>
                        <div class="layui-input-inline">
                            <select id="menu_status" name="menu_status">
                                <option value="1" selected>正常</option>
                                <option value="0" >禁用</option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label  class="layui-form-label" >菜单类型</label>
                        <div class="layui-input-inline" >
                            <select id="menu_type" name="menu_type">
                                <option value="2" selected>业务自有</option>
                                <option value="1" >框架内置</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label  class="layui-form-label" >是否显示</label>
                        <div class="layui-input-inline" >
                            <select id="menu_hidden" name="menu_hidden">
                                <option value="0" selected>显示</option>
                                <option value="1" >隐藏</option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label  class="layui-form-label" >沿用布局</label>
                        <div class="layui-input-inline" >
                            <select id="menu_use_sys_layout" name="menu_use_sys_layout">
                                <option value="1" selected>是</option>
                                <option value="0" >否</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="layui-form-item layui-form-text">
                    <label class="layui-form-label">备注</label>
                    <div class="layui-input-block" >
                        <textarea id="menu_remark" name="menu_remark" placeholder="备注" class="layui-textarea" rows="2"></textarea>
                    </div>
                </div>
                <div class="layui-form-item page-form-btn">
                    <button class="layui-btn" id="form_submit_btn" lay-filter="form_submit_btn" lay-submit>确定</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!--optmodel-->
<div id="opt_model_list" style="display:none;">
    <div class="layui-inline">
        <a class="layui-btn layui-btn-normal optAdd_btn">新增</a>
    </div>
    <div class="layui-inline">
        <a class="layui-btn layui-btn-normal optEdit_btn">修改</a>
    </div>
    <div class="layui-inline">
        <a class="layui-btn layui-btn-danger generate_btn" id="gen_btn">生成操作</a>
    </div>

    <div class="layui-form">
        <table class="layui-hide" id="optdatagrid" lay-data="{id: 'optdatagrid'}" ></table>
    </div>

</div>

<!--opt add model-->
<div id="opt_model" class="page_model" style="display:none;">
    <div class="layui-tab-item layui-show">
        <div class="layui-form layui-form-pane">
            <form id="opt_form" method="post" style="padding: 5px; line-height: 5px;">
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label  class="layui-form-label" >所属菜单</label>
                        <div class="layui-input-inline">
                            <input type="text" id="opt_menu_name" name="menu_name" required lay-verify="required" autocomplete="off" class="layui-input" readonly>
                        </div>
                    </div>
                    <div class="layui-inline" style="display: none">
                        <label  class="layui-form-label" >菜单id</label>
                        <div class="layui-input-inline">
                            <input type="text" id="opt_menu_id" name="menu_id" required lay-verify="required" autocomplete="off" class="layui-input" readonly>
                        </div>
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label  class="layui-form-label" >操作编码<span style="color: red">*</span></label>
                        <div class="layui-input-inline">
                            <input type="text" id="opt_code" name="opt_code" required lay-verify="required" autocomplete="off" placeholder="操作编码" class="layui-input" >
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label  class="layui-form-label" >操作名称<span style="color: red">*</span></label>
                        <div class="layui-input-inline">
                            <input type="text" id="opt_name" name="opt_name" required lay-verify="required" autocomplete="off" placeholder="操作名称" class="layui-input" >
                        </div>
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label" >操作方法<span style="color: red">*</span></label>
                        <div class="layui-input-inline">
                            <select id="opt_method" name="opt_method" required lay-verify="required">
                                <option value="get" selected>get</option>
                                <option value="post" >post</option>
                                <option value="put" >put</option>
                                <option value="delete" >delete</option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label" >操作url<span style="color: red">*</span></label>
                        <div class="layui-input-inline">
                            <input type="text" id="opt_url" name="opt_url" required lay-verify="required" autocomplete="off" placeholder="菜单导航" class="layui-input">
                        </div>
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label  class="layui-form-label" >排序号</label>
                        <div class="layui-input-inline">
                            <input type="number" id="opt_order" name="opt_order" autocomplete="off" value="1" class="layui-input" >
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label" >状态</label>
                        <div class="layui-input-inline">
                            <select id="opt_status" name="opt_status">
                                <option value="1" selected>正常</option>
                                <option value="0" >禁用</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="layui-form-item layui-form-text">
                    <label class="layui-form-label" >备注</label>
                    <div class="layui-input-block">
                        <textarea id="opt_remark" name="opt_remark" placeholder="备注" class="layui-textarea"></textarea>
                    </div>
                </div>
                <div class="layui-form-item" align="right">
                    <button class="layui-btn" id="optadd_btn" lay-filter="add_opt" lay-submit>确定</button>
                    <button class="layui-btn" id="optedit_btn" lay-filter="edit_opt" lay-submit>修改</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!--generate opt model-->
<div id="gen_opt_model" style="display: none;">
    <div class="layui-tab-item layui-show">
        <div class="layui-form layui-form-pane">
            <div class="layui-inline">
                <a class="layui-btn layui-btn-normal batchOptAdd_btn">批量新增</a>
            </div>
            <div class="layui-form">
                <table class="layui-hide" id="gen_datagrid" lay-data="{id: 'gen_datagrid'}"></table>
            </div>
        </div>
    </div>
</div>

<script type="text/html" id="optTpl">
    <a class="layui-btn layui-btn-xs" lay-event="Edit">编辑</a>
    <!--<a class="layui-btn layui-btn-xs" lay-event="opt_list">操作权限列表</a>-->
</script>

<script type="text/html" id="statusTpl">
    {{#out '{{d.menu_status == 1 ? "正常" : "禁用"}}'}}{{/out}}
</script>
<script type="text/html" id="optStatusTpl">
    {{#out '{{d.opt_status == 1 ? "正常" : "禁用"}}'}}{{/out}}
</script>
<script type="text/html" id="menuLevelStatusTpl">
    {{#out '{{d.menu_level == 1 ? "导航" : "菜单"}}'}}{{/out}}
</script>
<script type="text/html" id="menutargetTpl">
    {{#out '{{d.menu_target == "single" ? "单页" : d.menu_target == "iframe" ? "iframe" : "新窗口"}}'}}{{/out}}
</script>


<script>

    layui.use(['table','form','jquery','tree','layer'], function(){
        var table = layui.table;
        var form = layui.form;
        var $ = layui.$;
        var layer=layui.layer;
        var menuMap={};
        var currentSys;
        table.render({
            elem: '#datagrid'
            ,id: 'datagrid'
            ,url:'{{projcfg.base}}/menu/list.do'
            ,height: '{{projcfg.page_config.height}}'
            //,cellMinWidth: 10 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
            ,cols: [[
                {type:'numbers'},
                {type:'checkbox'},
                {field:'menu_code', title: '菜单编码',width:200,align:'left'}
                ,{field:'menu_name', title: '菜单名称',width:200,align:'left'}
                ,{field:'menu_url', title: 'url',align:'left'}
                ,{field:'menu_nav', title: '导航路径',align:'left'}
                ,{field:'menu_order', title: '排序号',width:80,align:'left',sort:true}
                //,{field:'menu_target', title: '打开方式',width:100,align:'left'}
                ,{field:'menu_target', title: '打开方式',width:100,toolbar: '#menutargetTpl',align:'left'}
                ,{field:'menu_level', title: '菜单层级',width:100,toolbar: '#menuLevelStatusTpl',align:'left'}
                ,{field:'menu_status', title: '状态',width:80,toolbar: '#statusTpl',align:'left'}
                // ,{field:'account_opt', title: '操作',width:200,toolbar: '#optTpl',align:'left'}
            ]]
            ,page: true
            ,done: function(res, curr, count) {
                signleSelect($, 'datagrid');
            }
        });

        //页面系统列表初始化
        $.ajax({
            url:'{{projcfg.base}}/common/syslist.do',
            type:'get',
            success:function (res) {
                $('#page_menu_sysid').html('');
                var items=res.data;
                for(var i in items){
                    $('#page_menu_sysid').append('<option value =\"' + items[i].id + '\">' + items[i].sys_name + '</option>');
                    form.render('select');
                }
                $('#page_menu_sysid').get(0).selectedIndex=0;
                //获取系统id的菜单
                var sys_id=$('#page_menu_sysid').val();
                var sys_name=$('#page_menu_sysid').find("option:selected").text();
                currentSys=sys_name;
                menuMap[sys_id]=sys_name;
                //系统菜单表格初始化
                table.reload('datagrid',{
                    url: '{{projcfg.base}}/menu/switchsys.do',
                    where:{sys_id:sys_id}
                })

                //菜单列表初始化
                $.ajax({
                    url:'{{projcfg.base}}/menu/menuList.do',
                    type:'get',
                    success:function (res) {
                        $('#menu_pid').html('');
                        var items=res.data;
                        //初始化菜单map
                        for(var i in items){
                            menuMap[items[i].id]=items[i].menu_name;
                        }

                        //添加系统做根
                        $('#menu_pid').append('<option value =\"' + 1 + '\">' + sys_name + '</option>');
                        for(var i in items){
                            $('#menu_pid').append('<option value =\"' + items[i].id + '\">' + items[i].menu_name + '</option>');
                            form.render('select');
                        }
                        $('#menu_pid').get(0).selectedIndex=0;
                    }
                });

                //菜单树形目录初始化
                $.ajax({
                    url:'{{projcfg.base}}/menu/menutree.do',
                    type:'get',
                    data:{'sysname':sys_name,'sysid':sys_id},
                    success:function (res) {
                        layui.tree({
                            elem:'#menutree',
                            nodes:JSON.parse(res.data),
                            click:function (node) {
                                if(node.hasOwnProperty('sys_id')){
                                    table.reload('datagrid',{
                                        url: '{{projcfg.base}}/menu/treeNode.do',
                                        where:{menu_id:node.id,sys_id:node.sys_id}
                                    })
                                }else{
                                    table.reload('datagrid',{
                                        url: '{{projcfg.base}}/menu/treeNode.do',
                                        where:{menu_id:node.id,sys_id:''}
                                    })
                                }

                            }
                        });
                    }
                });

                //菜单父亲select
                refreshMenuTree(sys_name,sys_id);

            }
        });

        function refreshMenuTree(sys_name,sys_id) {

            $.ajax({
                url:'{{projcfg.base}}/menu/menutree.do',
                type:'get',
                data:{'sysname':sys_name,'sysid':sys_id},
                success:function (res) {
                    $('#menuselecttree').empty();
                    layui.tree({
                        elem:'#menuselecttree',
                        nodes:JSON.parse(res.data),
                        click:function (node) {

                            $('#menu_pid').val(node.id);
                            var $select = $($(this)[0].elem).parents(".layui-form-select");
                            $select.removeClass("layui-form-selected").find(".layui-select-title span").html(node.name);
                            $('#menu_nav').val(node.nav + ' > ');
                        }
                    });
                }
            });
        }
        /*alert($(".downpanel .layui-select-title").length);
        $(".downpanel .layui-select-title").off("click");
        $(".downpanel .layui-select-title").on("click",function(e) {alert('------');
            $(".layui-form-select").not($(this).parents(".layui-form-select")).removeClass("layui-form-selected");
            $(this).parents(".downpanel").toggleClass("layui-form-selected");
            layui.stope(e);
        }).on("click","dl i",function(e) {
            layui.stope(e);
        });*/

        //获取系统列表
        $.ajax({
            url:'{{projcfg.base}}/common/syslist.do',
            type:'get',
            success:function (res) {
                $('#menu_sysid').html('');
                var items=res.data;
                for(var i in items){
                    $('#menu_sysid').append('<option value =\"' + items[i].id + '\">' + items[i].sys_name + '</option>');
                    form.render('select');
                }
                $('#menu_sysid').get(0).selectedIndex=0;
            }
        });




        //系统切换
        form.on('select(sysSelect)',function (data) {
            var sys_id=data.value;
            var sys_name=$('#page_menu_sysid').find("option:selected").text();
            currentSys=sys_name;
            menuMap[sys_id]=sys_name;
            refresh(sys_id,sys_name);
        });

        function refresh(sys_id,sys_name) {
            //数据表格切换
            table.reload('datagrid',{
                url: '{{projcfg.base}}/menu/switchsys.do',
                where:{sys_id:sys_id}
            })

            //菜单列表切换
            $.ajax({
                url:'{{projcfg.base}}/menu/menuList.do',
                type:'get',
                success:function (res) {
                    $('#menu_pid').html('');
                    var items=res.data;
                    //初始化菜单map
                    for(var i in items){
                        menuMap[items[i].id]=items[i].menu_name;
                    }

                    //添加系统做根
                    $('#menu_pid').append('<option value =\"' + 1 + '\">' + sys_name + '</option>');
                    for(var i in items){
                        $('#menu_pid').append('<option value =\"' + items[i].id + '\">' + items[i].menu_name + '</option>');
                        form.render('select');
                    }
                    $('#menu_pid').get(0).selectedIndex=0;
                }
            });

            //菜单切换
            $.ajax({
                url:'{{projcfg.base}}/menu/menutree.do',
                type:'get',
                data:{'sysname':sys_name,'sysid':sys_id},
                success:function (res) {
                    $('#menutree').empty();
                    layui.tree({
                        elem:'#menutree',
                        nodes:JSON.parse(res.data),//res.data,//
                        click:function (node) {
                            if(node.hasOwnProperty('sys_id')){
                                table.reload('datagrid',{
                                    url: '{{projcfg.base}}/menu/treeNode.do',
                                    where:{menu_id:node.id,sys_id:node.sys_id}
                                })
                            }else{
                                table.reload('datagrid',{
                                    url: '{{projcfg.base}}/menu/treeNode.do',
                                    where:{menu_id:node.id,sys_id:''}
                                })
                            }
                        }
                    });
                }
            });
        }

        //监听锁定操作
        form.on('checkbox(lock)', function(obj){
            console.log(obj);
            layer.tips(this.value + ' ' + this.name + '：'+ obj.elem.checked, obj.othis);
            var account_status='';

            var account_name= this.value;
            if(obj.elem.checked){
                account_status = 2;
            }else {
                account_status = 1;
            }
            var loading = layer.load(1);
            // alert(user_status);
            $.ajax({
                url: "{{projcfg.base}}/admin/lock.json",
                data: {account_name:account_name,account_status:account_status},
                method: 'POST',
                success: function (res) {

                    if (res.success) {
                        layer.close(loading);
                        layer.msg(res.msg, {icon: 6, time: 2000}, function () {

                        });
                    }
                    else {
                        layer.close(loading);
                        layer.msg(res.msg, {icon: 5});
                    }
                },
                error: function () {
                    layer.close(loading);
                    layer.msg("设置账号禁用状态失败", {icon: 5});
                }
            });
        });

        //增加菜单系统更换,父菜单跟着变
        form.on('select(pMenuSwitch)',function (data) {
            var sys_id=data.value;
            var sys_name=$('#menu_sysid').find("option:selected").text();
            $(".layui-select-title span").html('');
            $('#menu_pid').val('');
            $('#menu_nav').val('');

            refreshMenuTree(sys_name,sys_id);

        })

        //新增
        $(".newsAdd_btn").click(function(){
            openLayer(layui.layer, {
                title: '新增菜单',     //显示标题
                area: ['680px', '600px'], //宽高
                content:  $('#menu_model'),
                success: function(layero, index){
                    form.render();


                    //提交
                    form.on('submit(form_submit_btn)', function(data){
                        var loading = layer.load(1);
                        $.ajax({
                            url: "{{projcfg.base}}/menu/save.do",
                            data: data.field, //请求的附加参数
                            method: 'POST',
                            success: function (res) {
                                if(res.success) {
                                    layer.close(loading);
                                    layer.closeAll();
                                    layer.msg(res.msg, { icon: 6, time: 2000 }, function () {
                                        var sys_id=$('#menu_sysid').val();
                                        var sys_name=$('#menu_sysid').find("option:selected").text();
                                        $('#page_menu_sysid').val(sys_id);
                                        form.render('select');
                                        refresh(sys_id,sys_name);
                                        $(".layui-select-title span").html('');
                                        clear(data.field);
                                    });
                                }
                                else {
                                    layer.close(loading);
                                    layer.msg(res.msg, { icon: 5 });
                                }
                            },
                            error: function () {
                                layer.close(loading);
                                layer.msg("新建菜单失败", { icon: 5 });
                            }
                        });
                        return false;
                    });
                }
            }, '#form_submit_btn');
        });

        //修改
        $(".menuEdit_btn").click(function () {
            /*$('#add_btn').hide();
            $('#edit_btn').show();*/
            var checkStatus = table.checkStatus('datagrid');
            if (checkStatus.data.length != 1) {
                layer.msg("请选择一条数据。", {icon: 5});
            }
            else{
                var menudata=checkStatus.data;
                openLayer(layui.layer, {
                    title: '修改菜单',
                    area: ['680px', '600px'], //宽高
                    content: $('#menu_model'),
                    btn2: function(index, layero){
                        $(".layui-select-title span").html('');
                        clear(menudata[0]);
                        layer.close(index);
                    },
                    cancel: function (index, layero) {
                        $(".layui-select-title span").html('');
                        clear(menudata[0]);
                        layer.close(index);
                    },
                    // 窗口加载成功后调用
                    success: function(layero, index) {
                        var menu_pid=menudata[0].menu_pid;
                        console.log('menu pid',menu_pid);
                        console.log('menu map',menuMap);
                        if(menu_pid==1){
                            // $('#menu_pid_name').val(currentSys);
                            $(".layui-select-title span").html(currentSys);

                        }else{
                            // $('#menu_pid_name').val(menuMap[menu_pid]);
                            $(".layui-select-title span").html(menuMap[menu_pid]);

                        }
                        getData(menudata[0]);//编辑
                        //监听提交
                        form.on('submit(form_submit_btn)', function(formdata){
                            if(menudata[0].id == formdata.field.menu_pid) {
                                layer.msg("上级菜单和当前菜单不能相同", {icon: 5});
                                return false;
                            }
                            formdata.field.menu_id=menudata[0].id;
                            var loading = layer.load(1);
                            $.ajax({
                                url: "{{projcfg.base}}/menu/modify.do",
                                data: formdata.field, //请求的附加参数，用json对象
                                method: 'POST',
                                success: function (res) {
                                    //alert(res);
                                    if(res.success) {
                                        layer.close(loading);
                                        layer.closeAll();
                                        layer.msg(res.msg, { icon: 6, time: 2000 }, function () {
                                            var sys_id=$('#menu_sysid').val();
                                            var sys_name=$('#menu_sysid').find("option:selected").text();
                                            $('#page_menu_sysid').val(sys_id);
                                            form.render('select');
                                            refresh(sys_id,sys_name);
                                            refreshMenuTree(sys_name,sys_id);
                                            $(".layui-select-title span").html('');
                                            clear(menudata[0]);
                                        });
                                    }
                                    else {
                                        layer.close(loading);
                                        layer.msg(res.msg, { icon: 5 });
                                    }
                                },
                                error: function () {
                                    layer.close(loading);
                                    layer.msg("修改菜单信息失败", { icon: 5 });
                                }
                            });
                            return false;
                        });
                    }
                }, '#form_submit_btn');
            }
        })

        //监听工具条
        table.on('tool(TableFilter)', function(obj){ //注：tool是工具条事件名，test是table原始容器的属性 lay-filter="对应的值"
            var data = obj.data; //获得当前行数据
            var layEvent = obj.event; //获得 lay-event 对应的值

             if(layEvent === 'Edit'){
                $('#add_btn').hide();
                $('#edit_btn').show();
                var index = layer.open({
                    type: 1,                //弹窗类型
                    title: '修改菜单',     //显示标题
                    shade:false,
                    closeBtn: 1,         //是否显示关闭按钮
                    shadeClose: true, //显示模态窗口
                    // skin: 'layui-layer-rim', //加上边框
                    area: ['730px', '600px'], //宽高
                    content:  $('#menu_model'),
                    cancel:function (index,layero) {
                        layer.close(index);
                        location.reload();
                    }
                });
                 var menu_pid=data.menu_pid;
                 $('#menu_pid_name').val(menuMap[menu_pid]);
                 getData(data);//编辑
                //监听提交
                form.on('submit(edit_menu)', function(formdata){
                    var loading = layer.load(1);
                    $.ajax({
                        url: "{{projcfg.base}}/menu/modify.do/"+data.id,
                        data: formdata.field, //请求的附加参数，用json对象
                        method: 'POST',
                        success: function (res) {
                            //alert(res);
                            if(res.success) {
                                layer.close(loading);
                                layer.closeAll();
                                layer.msg(res.msg, { icon: 6, time: 2000 }, function () {
                                    location.reload();
                                });
                            }
                            else {
                                layer.close(loading);
                                layer.msg(res.msg, { icon: 5 });
                            }
                        },
                        error: function () {
                            layer.close(loading);
                            layer.msg("修改失败", { icon: 5 });
                        }
                    });
                    return false;
                });

            }else if(layEvent === 'opt_list'){
                var index = layer.open({
                    type: 1,                //弹窗类型
                    title: '操作权限列表',     //显示标题
                    shade:false,
                    closeBtn: 0,         //是否显示关闭按钮
                    shadeClose: true, //显示模态窗口
                    // skin: 'layui-layer-rim', //加上边框
                    area: ['700px', '550px'], //宽高
                    content:  $('#opt_model_list'),
                    shade:0.8,
                    btn:['关闭'],
                    yes:function (index,layero) {
                        layer.close(index);
                        location.reload();
                    }
                });
                //权限列表
                table.render({
                    elem: '#optdatagrid'
                    ,id: 'optdatagrid'
                    ,url:'{{projcfg.base}}/menu/optlist.do/'+data.id
                    ,height: 'full-100'
                    //,cellMinWidth: 10 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
                    ,cols: [[
                        {type:'numbers'},
                        {type:'checkbox'},
                        {field:'opt_name', title: '操作名称',width:100,align:'left'}
                        ,{field:'opt_url', title: 'url',align:'left'}
                        ,{field:'opt_status', title: '状态',width:100,toolbar: '#optStatusTpl',align:'left'}
                    ]]
                    ,page: true
                });

                //添加操作
                $(".optAdd_btn").click(function(){
                    $('#optedit_btn').hide();
                    $('#optadd_btn').show();
                    var index = layer.open({
                        type: 1,                //弹窗类型
                        title: '新增操作',     //显示标题
                        shade:false,
                        closeBtn: 1,         //是否显示关闭按钮
                        shadeClose: true, //显示模态窗口
                        // skin: 'layui-layer-rim', //加上边框
                        area: ['700px', '550px'], //宽高
                        content:  $('#opt_model')
                    });
                    $('#opt_menu_name').val(data.menu_name);
                    $('#opt_menu_id').val(data.id);
                    //监听提交
                    form.on('submit(add_opt)', function(data){
                        var loading = layer.load(1);
                        $.ajax({
                            url: "{{projcfg.base}}/menu/opt/save.do",
                            data: data.field, //请求的附加参数，用json对象
                            method: 'POST',
                            success: function (res) {
                                // alert(res);
                                if(res.success) {
                                    layer.close(loading);
                                    layer.closeAll();
                                    layer.msg(res.msg, { icon: 6, time: 2000 }, function () {
                                        location.reload();
                                    });
                                }
                                else {
                                    layer.close(loading);
                                    layer.msg(res.msg, { icon: 5 });
                                }
                            },
                            error: function () {
                                layer.close(loading);
                                layer.msg("新建菜单权限失败", { icon: 5 });
                            }
                        });
                        return false;
                    });
                });

                //修改操作
                $(".optEdit_btn").click(function(){
                    $('#optadd_btn').hide();
                    $('#optedit_btn').show();
                    var checkStatus = table.checkStatus('optdatagrid');
                    if (checkStatus.data.length != 1) {
                        layer.msg("请选择一条数据。", {icon: 5});
                    }else{
                        var optdata=checkStatus.data;
                        var index = layer.open({
                            type: 1,                //弹窗类型
                            title: '修改操作',     //显示标题
                            shade:false,
                            closeBtn: 1,         //是否显示关闭按钮
                            shadeClose: true, //显示模态窗口
                            // skin: 'layui-layer-rim', //加上边框
                            area: ['700px', '550px'], //宽高
                            content:  $('#opt_model'),
                            cancel:function (index,layero) {
                                layer.close(index);
                                location.reload();
                            }
                        });
                        $('#opt_menu_name').val(data.menu_name);
                        $('#opt_menu_id').val(data.id);
                        getData(optdata[0]);
                        //监听提交
                        form.on('submit(edit_opt)', function(data){
                        // console.log(data);

                        var loading = layer.load(1);
                        $.ajax({
                            url: "{{projcfg.base}}/menu/opt/modify.do/"+optdata[0].id,
                            data: data.field, //请求的附加参数，用json对象
                            method: 'POST',
                            success: function (res) {
                                if(res.success) {
                                    layer.close(loading);
                                    layer.closeAll();
                                    layer.msg(res.msg, { icon: 6, time: 2000 }, function () {
                                        location.reload();
                                    });
                                }
                                else {
                                    layer.close(loading);
                                    layer.msg(res.msg, { icon: 5 });
                                }
                            },
                            error: function () {
                                layer.close(loading);
                                layer.msg("修改菜单权限失败", { icon: 5 });
                            }
                        });
                        return false;
                    });
                    }
                })
            }

            //生成操作
            $(".generate_btn").click(function(){
                //菜单路由列表
                console.log("相应的菜单路由",data.menu_spt);
                if(!data.menu_spt){
                    layer.msg("没有找到相应的菜单路由", { icon: 5 });
                    return ;
                }
                var loading = layer.load(1);
                $.ajax({
                    url:'{{projcfg.base}}/menu/routes/list.do/'+data.menu_spt,
                    method:'get',
                    success:function (res) {
                        if(res.success) {
                            table.render({
                                elem: '#gen_datagrid'
                                ,height: 'full-100'
                                //,cellMinWidth: 10 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
                                ,cols: [[
                                    {type:'numbers'},
                                    {type:'checkbox'},
                                    {field:'opt_name', title: '操作名称',width:90,align:'left',edit:'text'}
                                    ,{field:'opt_code', title: '操作编码',width:90,align:'left',edit:'text'}
                                    ,{field:'opt_method', title: '操作方法',width:90,align:'left'}
                                    ,{field:'opt_url', title: '操作url',align:'left'}
                                    ,{field:'opt_status', title: '状态',width:60,align:'left'}
                                    ,{field:'opt_order', title: '排序号',width:80,align:'left',sort:true}
                                    ,{field:'opt_remark', title: '备注',align:'left',edit:'text'}
                                ]]
                                ,data:res.data
                                ,page: true
                            });
                            var index = layer.open({
                                type: 1,                //弹窗类型
                                title: '生成菜单操作',     //显示标题
                                shade:false,
                                closeBtn: 1,         //是否显示关闭按钮
                                shadeClose: true, //显示模态窗口
                                // skin: 'layui-layer-rim', //加上边框
                                area: ['700px', '550px'], //宽高
                                content:  $('#gen_opt_model')
                            })

                        }
                        else {
                            layer.msg(res.msg, { icon: 5 ,time:2000});
                        }
                    }
                    ,error:function () {
                        layer.close(loading);
                        layer.msg("获取菜单操作权限列表失败", { icon: 5 });
                    }
                });

                //监听提交
                form.on('submit(gen_opt)', function(data){
                    var loading = layer.load(1);
                    $.ajax({
                        url: "{{projcfg.base}}/menu/opt/generate.do",
                        data: data.field, //请求的附加参数，用json对象
                        method: 'POST',
                        success: function (res) {
                            if(res.success) {
                                layer.close(loading);
                                layer.closeAll();
                                layer.msg(res.msg, { icon: 6, time: 2000 }, function () {
                                    location.reload();
                                });
                            }
                            else {
                                layer.close(loading);
                                layer.msg(res.msg, { icon: 5 });
                            }
                        },
                        error: function () {
                            layer.close(loading);
                            layer.msg("生成菜单操作权限失败", { icon: 5 });
                        }
                    });
                    return false;
                });
            });

            //批量添加菜单权限
            $(".batchOptAdd_btn").click(function () {
                var checkStatus = table.checkStatus('gen_datagrid');
                if (checkStatus.data.length < 1) {
                    layer.msg("请选择一条数据。", {icon: 5});
                }else{
                    var checkedData=checkStatus.data;
                    console.log('checkStatus',checkStatus);
                    console.log('checkedData',JSON.stringify(checkedData));
                    var loading = layer.load(1);
                    $.ajax({
                        url: "{{projcfg.base}}/menu/opt/batch/generate.do/"+data.id,
                        data: {'opts':JSON.stringify(checkedData)}, //请求的附加参数，用json对象
                        method: 'POST',
                        success: function (res) {
                            if(res.success) {
                                layer.close(loading);
                                layer.closeAll();
                                layer.msg(res.msg, { icon: 6, time: 2000 }, function () {
                                    location.reload();
                                });
                            }
                            else {
                                layer.close(loading);
                                layer.msg(res.msg, { icon: 5 });
                            }
                        },
                        error: function () {
                            layer.close(loading);
                            layer.msg("新建菜单权限失败", { icon: 5 });
                        }
                    });
                }
            })
        });

        //回填数据修改 id与键一致
        function getData(data) {
            for(var k in data){
                $('#'+k).val(data[k]);
            }
            form.render();
        }

        //清空表单
        function clear(data) {
            for(var k in data){
                $('#'+k).val('');
            }
            form.render();
        }

        //查询
        $(".search_btn").click(function(){
            var menu_name = $(".search_input").val();
            if($(".search_input").val() != ''){
                table.reload('datagrid',{
                    where: { //设定异步数据接口的额外参数，任意设
                        menu_name:menu_name,
                    },
                    page: {
                        curr: 1 //重新从第 1 页开始
                    }
                });
            }else{
                layer.msg("请输入需要查询的内容");
            }
        })
        //重置
        $(".rest_btn").click(function(){
            $(".search_input").val("");
            table.reload('datagrid',{
                where: { //设定异步数据接口的额外参数，任意设
                    menu_name:'',
                },
                page: {
                    curr: 1 //重新从第 1 页开始
                }
            });
        })
    });
</script>