<blockquote class="layui-elem-quote news_search">
    <div class="layui-inline">
        <div class="layui-input-inline">
            <input type="text" value="" placeholder="系统编码/名称" class="layui-input search_input">
        </div>
        <a class="layui-btn layui-btn-primary search_btn"><i class="layui-icon">&#xe615;</i>查询</a>
    </div>
    <div class="layui-inline">
        <a class="layui-btn layui-btn-primary rest_btn"><i class="layui-icon">&#xe65c;</i>重置</a>
    </div>
    <div class="layui-inline">
        <a class="layui-btn layui-btn-primary newsAdd_btn"><i class="layui-icon">&#xe654;</i>新增</a>
    </div>
    <div class="layui-inline">
        <a class="layui-btn layui-btn-primary Edit_btn"><i class="layui-icon">&#xe642;</i>修改</a>
    </div>
    <div class="layui-inline">
        <div class="layui-form-mid layui-word-aux"></div>
    </div>
</blockquote>
<div class="layui-form news_list">
    <table class="layui-hide" id="datagrid" lay-data="{id: 'datagrid'}" lay-size="sm" lay-filter="TableFilter"></table>
</div>

<!-- Modal -->
<div id="sys_model" class="page_model" style="display:none;">
    <div class="layui-show">
        <div class="layui-form layui-form-pane">
            <form id="testForm" method="post" style="padding: 5px; line-height: 5px;">
                <div class="layui-form-item">
                    <label for="L_syscode" class="layui-form-label">系统编码<span style="color:red">*</span></label>
                    <div class="layui-input-block">
                        <input type="text" id="sys_code" name="sys_code" required lay-verify="required" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label for="L_sysname" class="layui-form-label">系统名称<span style="color:red">*</span></label>
                    <div class="layui-input-block">
                        <input type="text" id="sys_name" name="sys_name" required lay-verify="required" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label for="L_sysurl" class="layui-form-label">访问路径<span style="color:red">*</span></label>
                    <div class="layui-input-block">
                        <input type="text" id="sys_url" name="sys_url" required lay-verify="required" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label for="L_sys_mainrul" class="layui-form-label">主页路径<span style="color:red">*</span></label>
                    <div class="layui-input-block">
                        <input type="text" id="sys_main_url" name="sys_main_url" required lay-verify="required" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">主题样式<span style="color:red">*</span></label>
                        <div class="layui-input-inline">
                            <select name="sys_theme_layout" id="sys_theme_layout" required lay-verify="required" value="">
                                <option value=""></option>
                                {{# each projcfg.theme_define}}
                                    {{#if on}}
                                <option value="{{layout}}">{{title}}</option>
                                    {{/if}}
                                {{/each}}
                            </select>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">状态</label>
                        <div class="layui-input-inline">
                            <select name="sys_status" id="sys_status" value="1">
                                <option value="1" >启用</option>
                                <option value="0" >禁用</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="layui-form-item layui-form-text">
                    <label for="L_sysremark" class="layui-form-label">系统备注</label>
                    <div class="layui-input-block">
                        <textarea id="sys_remark" name="sys_remark" placeholder="请输入系统备注" class="layui-textarea" rows="2"></textarea>
                    </div>
                </div>
                <div class="layui-form-item page-form-btn">
                    <button class="layui-btn" id="form_submit_btn" lay-filter="form_submit_btn" lay-submit>确定</button>
                </div>
            </form>
        </div>
    </div>
</div>



<script type="text/html" id="optTpl">
    <a class="layui-btn layui-btn-xs" lay-event="Edit">编辑</a>
</script>

<script type="text/html" id="statusTpl">
        {{#out '{{d.sys_status == 1 ? "启用" : "禁用"}}'}}{{/out}}
</script>

<script>

    layui.use(['table','form','jquery'], function(){
        var table = layui.table;
        var form = layui.form;
        var $ = layui.$;
        table.render({
            elem: '#datagrid'
            ,id: 'datagrid'
            ,url:'{{projcfg.base}}/system/list.do'
            ,height: '{{projcfg.page_config.height}}'
            //,cellMinWidth: 30 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
            ,cols: [[
                {type:'numbers'},
                {type:'checkbox'},
                {field:'sys_code', title: '系统编码',width:120,align:'left'}
                ,{field:'sys_name', title: '系统名',align:'left'}
                ,{field:'sys_url', title: '系统访问路径',align:'left'}
                ,{field:'sys_main_url', title: '系统主页访问路径',align:'left'}
                ,{field:'sys_status', title: '系统状态',width:120,toolbar: '#statusTpl',align:'left'}
                //,{field:'account_opt', title: '操作',width:170,toolbar: '#optTpl',align:'left'}
            ]]
            ,page: true
            ,done: function(res, curr, count) {
                signleSelect($, 'datagrid');
            }
        });

        //新增
        $(".newsAdd_btn").click(function(){
            openLayer(layui.layer, {
                title: '新增系统',     //显示标题
                area: ['750px', '500px'], //宽高
                content:  $('#sys_model'),
                success: function(layero, index){
                    form.render();

                    //监听提交
                    form.on('submit(form_submit_btn)', function(data){
                        var loading = layer.load(1);
                        $.ajax({
                            url: "{{projcfg.base}}/system/save.do",
                            data: data.field, //请求的附加参数，用json对象
                            method: 'POST',
                            success: function (res) {
                                //alert(res);
                                if(res.success) {
                                    layer.close(loading);
                                    layer.closeAll();
                                    layer.msg(res.msg, { icon: 6, time: 2000 }, function () {
                                        //location.reload();
                                        reload();
                                    });
                                }
                                else {
                                    layer.close(loading);
                                    layer.msg(res.msg, { icon: 5 });
                                }
                            },
                            error: function () {
                                layer.close(loading);
                                layer.msg("新建系统失败", { icon: 5 });
                            }
                        });

                        return false;
                    });
                }
            }, '#form_submit_btn');
        })


        //修改
        $(".Edit_btn").click(function () {
            var checkStatus = table.checkStatus('datagrid');
            if (checkStatus.data.length != 1) {
                layer.msg("请选择一条数据。", {icon: 5});
            } else {
                var sysdata = checkStatus.data;

                openLayer(layui.layer, {
                    title: '修改系统',
                    area: ['655px', '450px'], //宽高
                    content: $('#sys_model'),
                    btn2: function(index, layero){
                        clear(sysdata[0]);
                        layer.close(index);
                    },
                    cancel: function (index, layero) {
                        clear(sysdata[0]);
                        layer.close(index);
                    },
                    // 窗口加载成功后调用
                    success: function(layero, index) {
                        getdata(sysdata[0]);//回填

                        //监听提交
                        form.on('submit(form_submit_btn)', function(formdata){
                            formdata.field.id = sysdata[0].id;
                            var loading = layer.load(1);
                            $.ajax({
                                url: "{{projcfg.base}}/system/modify.do",
                                data: formdata.field, //请求的附加参数，用json对象
                                method: 'POST',
                                success: function (res) {
                                    //alert(res);
                                    if(res.success) {
                                        layer.close(loading);
                                        layer.closeAll();
                                        layer.msg(res.msg, { icon: 6, time: 2000 }, function () {
                                            //location.reload();
                                            reload();
                                        });
                                    }
                                    else {
                                        layer.close(loading);
                                        layer.msg(res.msg, { icon: 5 });
                                    }
                                },
                                error: function () {
                                    layer.close(loading);
                                    layer.msg("修改失败", { icon: 5 });
                                }
                            });
                            return false;
                        });
                    }
                }, '#form_submit_btn');
            }
        });


        //弹窗回填
        function getdata(data){

            for(var k in data){
                $('#'+k).val(data[k]);
            }
            form.render();
        }

        //清除弹窗
        function clear(data) {
            for(var k in data){
                $('#'+k).val('');
            }
            form.render();
        }

        function reload() {
            table.reload('datagrid', {

            });
        }


        //查询
        $(".search_btn").click(function(){

            var sys_name = $(".search_input").val();
            if($(".search_input").val() != ''){

                table.reload('datagrid',{
                    where: { //设定异步数据接口的额外参数，任意设
                        sys_name:sys_name
                    },
                    page: {
                        curr: 1 //重新从第 1 页开始
                    }
                });
            }else{
                layer.msg("请输入需要查询的内容");
            }
        })
        //重置
        $(".rest_btn").click(function(){

            $(".search_input").val("");
            table.reload('datagrid',{
                where: { //设定异步数据接口的额外参数，任意设
                    sys_name:''
                },
                page: {
                    curr: 1 //重新从第 1 页开始
                }
            });
        })
    });
</script>