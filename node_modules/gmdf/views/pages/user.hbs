<style type="text/css">
    .downpanel dl dd:hover{background-color: inherit;}
    .layui-layer-page .layui-layer-content { overflow: visible; }
</style>

<blockquote class="layui-elem-quote news_search">
    <div class="layui-inline">
        <div class="layui-input-inline layui-form">
            <select id="page_user_sysid" name="page_user_sysid" lay-filter="sysSelect">
            </select>
        </div>
    </div>
    <div class="layui-inline">
        <div class="layui-input-inline">
            <input type="text" value="" placeholder="账号/姓名" class="layui-input search_input">
        </div>
        <a class="layui-btn layui-btn-primary search_btn"><i class="layui-icon">&#xe615;</i>查询</a>
    </div>
    <div class="layui-inline">
        <a class="layui-btn layui-btn-primary rest_btn"><i class="layui-icon">&#xe65c;</i>重置</a>
    </div>
    <div class="layui-inline">
        <a class="layui-btn layui-btn-primary newsAdd_btn"><i class="layui-icon">&#xe654;</i>新增</a>
    </div>
    <div class="layui-inline">
        <a class="layui-btn layui-btn-primary Edit_btn"><i class="layui-icon">&#xe642;</i>修改</a>
    </div>
    <div class="layui-inline">
        <a class="layui-btn layui-btn-primary Reset_btn"><i class="layui-icon">&#xe628;</i>重置密码</a>
    </div>
    <div class="layui-inline">
        <div class="layui-form-mid layui-word-aux"></div>
    </div>
</blockquote>

<div class="layui-form news_list">
    <table class="layui-hide" id="datagrid" lay-data="{id: 'datagrid'}" lay-filter="TableFilter"></table>
</div>

<!-- Modal -->
<div id="user_model" class="page_model" style="display:none;">
    <div class="layui-show">
        <div class="layui-form layui-form-pane">
            <form method="post" style="padding: 5px; line-height: 5px;">
                <br><br><br>
                <h3>账号信息</h3>
                <hr>
                <div class="layui-form-item">
                    <label for="L_sysurl" class="layui-form-label">登录账号<span style="color:red">*</span></label>
                    <div class="layui-input-block">
                        <input type="text" id="login_account" name="login_account" required lay-verify="required" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label for="L_sysurl" class="layui-form-label">登录密码<span style="color:red">*</span></label>
                    <div class="layui-input-inline">
                        <input type="password" name="login_password" id="login_password" required lay-verify="required|newPwd" placeholder="请输入密码" autocomplete="new-password" class="layui-input">
                    </div>
                    <div class="layui-form-mid layui-word-aux">密码为8～18位大小写字母数字和特殊字符组成</div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">归属系统<span style="color:red">*</span></label>
                        <div class="layui-input-inline">
                            <select name="user_sys" id="user_sys" required lay-verify="required" lay-filter="system">
                                <option value=""></option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">状态<span style="color:red">*</span></label>
                        <div class="layui-input-inline">
                            <select name="user_status" id="user_status" required lay-verify="required">
                                <option value="1" >启用</option>
                                <option value="0" >禁用</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label for="L_usercode" class="layui-form-label">拥有角色<span style="color:red">*</span></label>
                    <div class="layui-input-block">
                        <select name="role_id" id="role_id" lay-filter="role_id">
                            <option value=""></option>
                        </select>
                        <input type="text" id="role" name="role" autocomplete="off" class="layui-input" style="display: none;">
                    </div>
                </div>
                <br><br><br>
                <h3>用户信息</h3>
                <hr>
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label for="L_username" class="layui-form-label">用户编号<span style="color:red">*</span></label>
                        <div class="layui-input-inline">
                            <input type="text" id="user_no" name="user_no" required lay-verify="required" autocomplete="off" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label for="L_username" class="layui-form-label">用户姓名<span style="color:red">*</span></label>
                        <div class="layui-input-inline">
                            <input type="text" id="user_name" name="user_name" required lay-verify="required" autocomplete="off" class="layui-input">
                        </div>
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label" >所在机构<span style="color:red">*</span></label>
                        <div class="layui-input-inline">
                            <div class="layui-unselect layui-form-select downpanel">
                                <div class="layui-select-title" onclick="openSelectTree()">
                                    <span class="layui-input layui-unselect" id="treeclass"></span>
                                    <input type="hidden" name="user_org" id="user_org">
                                    <i class="layui-edge"></i>
                                </div>
                                <dl class="layui-anim layui-anim-upbit">
                                    <dd>
                                        <ul id="classtree"></ul>
                                    </dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">用户类别<span style="color:red">*</span></label>
                        <div class="layui-input-inline">
                            <input type="text" id="user_type" value="1" readonly="readonly" name="user_type" autocomplete="off" class="layui-input">
                        </div>
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label for="L_sys_mainrul" class="layui-form-label">手机号码<span style="color:red">*</span></label>
                        <div class="layui-input-inline">
                            <input type="text" id="user_phone" name="user_phone" autocomplete="off" class="layui-input" required lay-verify="required|phone">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label for="L_sys_mainrul" class="layui-form-label">邮箱</label>
                        <div class="layui-input-inline">
                            <input type="text" id="user_email" name="user_email" autocomplete="off" class="layui-input" lay-verify="Email">
                        </div>
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">用户性别</label>
                        <div class="layui-input-inline">
                            <select name="user_sex" id="user_sex">
                                <option value="1" >男</option>
                                <option value="0" >女</option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">备注</label>
                        <div class="layui-input-inline">
                            <input type="text" id="user_remark" name="user_remark" autocomplete="off" class="layui-input">
                        </div>
                    </div>
                </div>
                {{#if projcfg.account.sync.status}}
                <br><br><br>
                <h3>账号同步</h3>
                <hr>
                <div class="layui-form-item" pane>
                    <label for="L_usercode" class="layui-form-label">分类</label>
                    <div class="layui-input-block">
                        {{#each projcfg.account.sync.catalog}}
                            {{#if on}}
                            <input type="checkbox" name="catalog" value="{{value}}" title="{{title}}" lay-skin="primary" {{#if disabled}} disabled{{/if}} {{#if checked}} checked{{/if}}>
                            {{/if}}
                        {{/each}}
                    </div>
                </div>
                {{/if}}
                <div class="layui-form-item page-form-btn">
                    <button class="layui-btn" id="form_submit_btn" lay-filter="form_submit_btn" lay-submit>确定</button>
                </div>
            </form>
        </div>
    </div>
</div>


<script type="text/html" id="statusTpl">
        {{#out '{{d.user_status == 1 ? "启用" : "禁用"}}'}}{{/out}}
</script>
{{#if projcfg.account.sync.status}}
<script type="text/html" id="syncTpl">
        {{#out '{{#
                var formatSyncStatus = function(data){
                    var result = "";
                    if(!data){
                        var catalogs = document.getElementsByName("catalog");
                        for(var i=0; i<catalogs.length;i++) {
                            result += "<span class=\'layui-badge layui-bg-gray\'>"+catalogs[i].value+"</span>&nbsp;";
                        }
                    }
                    else{
                        var array = data.split(",");
                        for(var i =0; i<array.length; i++){
                            var item = array[i].split(":");
                            if(item[1] == 1){
                                result += "<span class=\'layui-badge layui-bg-green\'>"+item[0]+"</span>&nbsp;";
                            }
                            else {
                                result += "<span class=\'layui-badge layui-bg-gray\'>"+item[0]+"</span>";
                            }
                        }
                    }
                    return result;
                };
                }}'
        }}{{/out}}
        {{#out '{{formatSyncStatus(d.sync_catalog_status)}}'}}{{/out}}
</script>
{{/if}}
<script src="static/js/selectMultiple/formSelects.js" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript">
    formSelects.on({
        layFilter: 'role_id',	//绑定select lay-filter
        left: '',			//显示的符号left
        right: '',			//显示的符号right
        separator: ',',		//多选分隔符
    });

    function formatJson(arr){
        var newarr = [];
        if(arr.length != 0){
            for(var k in arr){
                newarr.push(arr[k].val);
                document.getElementById("role").value = newarr;
            }
        }else{
            document.getElementById("role").value = '';
        }
    }
</script>


<script>
    layui.use(["tree","jquery"],function() {
        var $ = layui.jquery,
                tree = layui.tree;

        //树
        $.ajax({
            url:"{{projcfg.base}}/org/tree.do",
            method :'get',
            success:function (res) {
                //console.log('res = ',res.data);
                layui.tree({
                    elem:'#classtree',
                    nodes:JSON.parse(res.data),
                    click:function (node) {
                        $('#user_org').val(node.id);
                        var $select=$($(this)[0].elem).parents(".layui-form-select");
                        $select.removeClass("layui-form-selected").find(".layui-select-title span").html(node.name);
                    }
                });
            }
        });

        /*$(".downpanel").on("click",".layui-select-title",function(e) {
            $(".layui-form-select").not($(this).parents(".layui-form-select")).removeClass("layui-form-selected");
            $(this).parents(".downpanel").toggleClass("layui-form-selected");
            layui.stope(e);
        }).on("click","dl i",function(e) {
            layui.stope(e);
        });*/
    })

</script>

<script>
    layui.use(['table','form','jquery'], function(){
        var table = layui.table;
        var form = layui.form,
                $ = layui.jquery;

        //表格
        table.render({
            elem: '#datagrid'
            ,id: 'datagrid'
            ,url:'{{projcfg.base}}/user/list.do'
            ,height: '{{projcfg.page_config.height}}'
            //,cellMinWidth: 10 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
            ,cols: [[
                {type:'numbers'},
                {type:'checkbox'},
                {field:'user_no', title: '用户编号',width:120,align:'left'}
                ,{field:'user_name', title: '用户姓名',align:'left'}
                ,{field:'login_account', title: '登录账号',align:'left'}
                ,{field:'user_phone', title: '手机号码',align:'left'}
                ,{field:'org_name', title: '所在机构',align:'left'}
                ,{field:'sys_name', title: '归属系统',align:'left'}
                ,{field:'user_type_name', title: '人员类型',align:'left'}
                ,{field:'user_status', title: '状态',width:120,toolbar: '#statusTpl',align:'left'}
            {{#if projcfg.account.sync.status}}
                ,{field:'sync_catalog_status', title: '同步结果(绿:已同步；灰:未同步；)',toolbar:'#syncTpl',align:'left'}
            {{/if}}
            ]]
            ,page: true
            ,done: function(res, curr, count) {
                signleSelect($, 'datagrid');
            }
        });


        form.verify({
            newPwd : function (value,item) {
                if(!/^[0-9a-zA-Z!@#$%^&*]{8,18}$/.test(value)){
                    return "密码为8～18位大小写字母数字和特殊字符的组成";
                }
            },
            Email : function (value,item) {
                if(value != ""){
                    if(!/^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/.test(value)){
                        return "邮箱格式不正确";
                    }
                }
            }
        });

        //获取组织列表
        $.ajax({
            url:'{{projcfg.base}}/user/orglist.do',
            type:'get',
            success:function (res) {
                $('#org').html('');
                var items=res.data;
                for(var i in items){
                    $('#org').append('<option value =\"' + items[i].org_id + '\">' + items[i].org_name + '</option>');
                    $('#user_org').append('<option value =\"' + items[i].org_id + '\">' + items[i].org_name + '</option>');
                    form.render('select');
                }
                //$('#org').get(0).selectedIndex=0;
            }
        });

        //获取系统列表
        $.ajax({
            url:'{{projcfg.base}}/common/syslist.do',
            type:'get',
            success:function (res) {
                var items=res.data;
                for(var i in items){
                    $('#page_user_sysid').append('<option value =\"' + items[i].id + '\">' + items[i].sys_name + '</option>');
                    $('#user_sys').append('<option value =\"' + items[i].id + '\">' + items[i].sys_name + '</option>');
                    form.render('select');
                }
                var sys_id=$('#page_user_sysid').val();
                table.reload('datagrid',{
                    url: '{{projcfg.base}}/user/switchsys.do',
                    where:{sys_id:sys_id}
                })

            }
        });

        //获取人员类型
        $.ajax({
            url:'{{projcfg.base}}/user/stylelist.do',
            type:'get',
            success:function (res) {
                $('#user_type').html('');
                var items=res.data;
                for(var i in items){
                    $('#user_type').append('<option value =\"' + items[i].item_value + '\">' + items[i].item_text + '</option>');
                    form.render('select');
                }
            }
        });


        //根据选中的系统获取角色列表
        form.on('select(system)', function(data){
            formSelects.reset();
            $.ajax({
                url:'{{projcfg.base}}/user/rolelist.do',
                type:'post',
                data:{user_sys:data.value},
                success:function (res) {
                    $('#role_id').html('');
                    var items=res;
                    $('#role_id').append('<option value ="">' + '请选择' + '</option>');
                    for(var i in items){
                        $('#role_id').append('<option value =\"' + items[i].id + '\">' + items[i].role_name + '</option>');
                        form.render('select');
                    }
                }
            });
        });

        //根据系统选项重置表格
        form.on('select(sysSelect)', function(data){
            var sys_id=data.value;
            table.reload('datagrid',{
                url: '{{projcfg.base}}/user/switchsys.do',
                where:{sys_id:sys_id}
            })
        });


        //新增
        $(".newsAdd_btn").click(function(){
            document.getElementById("login_password").readOnly=false;
            openLayer(layui.layer, {
                title: '新增用户',     //显示标题
                area: ['750px', '580px'], //宽高
                content:  $('#user_model'),
                success: function(layero, index){
                    form.render();

                    //监听提交
                    form.on('submit(form_submit_btn)', function(data){
                        console.log(data);
                        /*$("#catalog :checkbox[checked]").each(function(i){
                            arr[i] = $(this).val();
                        });*/
                        var sync_catalog = new Array();
                        $("input[name='catalog']:checked").each(function(){
                            sync_catalog.push($(this).val());           //动态拼取选中的checkbox的值，用“|”符号分隔
                        });
                        var field = data.field;
                        field.sync_catalog = sync_catalog.join(',');
                        var loading = layer.load(1);
                        $.ajax({
                            url: "{{projcfg.base}}/user/save.do",
                            data: data.field, //请求的附加参数，用json对象
                            method: 'POST',
                            success: function (res) {
                                //alert(res);
                                if(res.success) {
                                    layer.close(loading);
                                    layer.closeAll();
                                    layer.msg(res.msg, { icon: 6, time: 2000 }, function () {
                                        //location.reload();
                                        reload();
                                    });
                                }
                                else {
                                    layer.close(loading);
                                    layer.msg(res.msg, { icon: 5 });
                                }
                            },
                            error: function () {
                                layer.close(loading);
                                layer.msg("新建用户失败", { icon: 5 });
                            }
                        });

                        return false;
                    }); }
            }, '#form_submit_btn');
        });


        //修改
        $('.Edit_btn').click(function () {
            var checkStatus = table.checkStatus('datagrid');
            if (checkStatus.data.length != 1) {
                layer.msg("请选择一条数据。", {icon: 5});
            } else {
                var userdata = checkStatus.data;

                openLayer(layui.layer, {
                    title: '修改账号',     //显示标题
                    area: ['750px', '580px'], //宽高
                    content: $('#user_model'),
                    btn2: function(index, layero){
                        $(".layui-select-title span").html('');
                        clear(userdata[0]);
                        layer.close(index);
                    },
                    cancel: function (index, layero) {
                        $(".layui-select-title span").html('');
                        clear(userdata[0]);
                        layer.close(index);
                    },
                    // 窗口加载成功后调用
                    success: function(layero, index) {

                        getdata(userdata[0]);//回填


                        form.on('submit(form_submit_btn)', function (formdata) {
                            formdata.field.user_id = userdata[0].user_id;
                            var sync_catalog = new Array();
                            $("input[name='catalog']:checked").each(function(){
                                sync_catalog.push($(this).val());           //动态拼取选中的checkbox的值，用“|”符号分隔
                            });
                            var field = formdata.field;
                            field.sync_catalog = sync_catalog.join(',');
                            var loading = layer.load(1);
                            $.ajax({
                                url: "{{projcfg.base}}/user/modify.do",
                                data: formdata.field, //请求的附加参数，用json对象
                                method: 'POST',
                                success: function (res) {
                                    //alert(res);
                                    if (res.success) {
                                        layer.close(loading);
                                        layer.closeAll();
                                        layer.msg(res.msg, {icon: 6, time: 2000}, function () {
                                            //location.reload();
                                            reload();
                                        });
                                    }
                                    else {
                                        layer.close(loading);
                                        layer.msg(res.msg, {icon: 5});
                                    }
                                },
                                error: function () {
                                    layer.close(loading);
                                    layer.msg("修改失败", {icon: 5});
                                }
                            });
                            return false;
                        });
                    }
                }, '#form_submit_btn');
            }
        });


        //重置密码
        $('.Reset_btn').click(function () {
            var checkStatus = table.checkStatus('datagrid');
            if (checkStatus.data.length != 1) {
                layer.msg("请选择一条数据。", {icon: 5});
            } else {
                layer.confirm('真的要重置密码吗？', function(index) {
                    var userdata = checkStatus.data;

                    layer.close(index);
                    $.ajax({
                        url: "{{projcfg.base}}/user/reset.do",
                        data: {user_id:userdata[0].user_id,login_account: userdata[0].login_account},
                        method: 'POST',
                        success: function (res) {

                            if (res.success) {
                                //layer.close(loading);
                                layer.msg(res.msg, {icon: 6, time: 2000}, function () {
                                });
                            }
                            else {
                                //layer.close(loading);
                                layer.msg(res.msg, {icon: 5});
                            }
                        },
                        error: function () {
                            //layer.close(loading);
                            layer.msg("重置密码失败", {icon: 5});
                        }
                    });
                })
            }
        });


        //弹窗回填
        function getdata(data){
            console.log(data);
            //普通元素回填
            for(var k in data){
                $('#'+k).val(data[k]);
            }
            $('#login_password').val("1234567890a");
            document.getElementById("login_password").readOnly=true;
            form.render();

            //多选回填

            //1、根据用户系统获取该系统角色
            $.ajax({
                url:'{{projcfg.base}}/user/rolelist.do',
                type:'post',
                data:{user_sys:data.user_sys},
                success:function (res) {
                    $('#role_id').html('');
                    var items=res;
                    $('#role_id').append('<option value ="">' + '请选择' + '</option>');
                    for(var i in items){
                        $('#role_id').append('<option value =\"' + items[i].id + '\">' + items[i].role_name + '</option>');
                        form.render('select');
                    }
                }
            });

            formSelects.reset();  //重置多选框

            //2、判断系统是否更改
            var currentchoose = $('#user_sys').val();
            if(currentchoose == data.user_sys){
                //3、获取用户当前角色
                $.ajax({
                    url:'{{projcfg.base}}/user/currentrole.do',
                    type:'POST',
                    data: {user_id:data.user_id},
                    success:function (res) {
                        var arr = [];
                        for(var i=0;i<res.length;i++){
                            formSelects.push(res[i]);
                            formSelects.show();
                            arr.push(res[i].val);
                            $('#role').val(arr);
                        }
                    }
                });
            }else{
                //重置角色
                formSelects.reset();  //重置多选框
                $('#role').val('');
            }

            //下拉框树回填
            $.ajax({
                url:'{{projcfg.base}}/user/orginfo.do',
                type:'POST',
                data: {user_org:data.user_org},
                success:function (res) {
                    for (var k in res){
                        console.log(res);
                        $(".layui-select-title span").html(res[k].org_name)
                    }
                }
            });

        }

        //清除弹窗
        function clear(data) {
            for(var k in data){
                $('#'+k).val('');
            }
            form.render();
            formSelects.reset();  //重置多选框
            $('#role').val('');
            $('#user_sex').val(1);
        }


        function reload() {
            table.reload('datagrid', {

            });
        }


        //查询
        $(".search_btn").click(function(){

            var user_name = $(".search_input").val();
            if($(".search_input").val() != ''){

                table.reload('datagrid',{
                    where: { //设定异步数据接口的额外参数，任意设
                        user_name:user_name
                    },
                    page: {
                        curr: 1 //重新从第 1 页开始
                    }
                });
            }else{
                layer.msg("请输入需要查询的内容");
            }
        })
        //重置
        $(".rest_btn").click(function(){

            $(".search_input").val("");
            table.reload('datagrid',{
                where: { //设定异步数据接口的额外参数，任意设
                    user_name:''
                },
                page: {
                    curr: 1 //重新从第 1 页开始
                }
            });
        })
    });
</script>
