<div class="layui-row">
    <div class="layui-col-md4">
        <blockquote class="layui-elem-quote news_search">
            <div class="layui-inline">
                <div class="layui-input-inline">
                    <input type="text" value="" placeholder="字典名称/编码" class="layui-input searchDict_input">
                </div>
                <a class="layui-btn layui-btn-primary searchDict_btn"><i class="layui-icon">&#xe615;</i>查询</a>
            </div>
            <div class="layui-inline">

                <a class="layui-btn layui-btn-primary restDict_btn"><i class="layui-icon">&#xe65c;</i>重置</a>
            </div>
            <div class="layui-inline">
                <a class="layui-btn layui-btn-primary dictAdd_btn"><i class="layui-icon">&#xe654;</i>新增</a>

            </div>
            <div class="layui-inline">
                <a class="layui-btn layui-btn-primary dictEdit_btn"><i class="layui-icon">&#xe642;</i>修改</a>

            </div>
            <div class="layui-inline">
                <a class="layui-btn layui-btn-primary toAuthority_btn"><i class="layui-icon">&#x1002;</i>同步</a>

            </div>
            <div class="layui-inline">
                <div class="layui-form-mid layui-word-aux"></div>
            </div>
        </blockquote>
        <div class="layui-form news_list">
            <table class="layui-hide" id="dict_datagrid" lay-data="{id: 'dict_datagrid'}" lay-filter="dictTableFilter"></table>
        </div>
    </div>
    <div class="layui-col-md8">
        <blockquote class="layui-elem-quote news_search">
            <div class="layui-inline">
                <div class="layui-input-inline">
                    <input type="text" value="" placeholder="字段名称/编码" class="layui-input searchItem_input">
                </div>
                <a class="layui-btn layui-btn-primary searchItem_btn"><i class="layui-icon">&#xe615;</i>查询</a>
            </div>
            <div class="layui-inline">

                <a class="layui-btn layui-btn-primary restItem_btn"><i class="layui-icon">&#xe65c;</i>重置</a>
            </div>
            <div class="layui-inline">
                <a class="layui-btn layui-btn-primary itemAdd_btn"><i class="layui-icon">&#xe654;</i>新增</a>

            </div>
            <div class="layui-inline">
                <a class="layui-btn layui-btn-primary itemEdit_btn"><i class="layui-icon">&#xe642;</i>修改</a>

            </div>
            <div class="layui-inline">
                <div class="layui-form-mid layui-word-aux"></div>
            </div>
        </blockquote>
        <div class="layui-form news_list">
            <table class="layui-hide" id="item_datagrid" lay-data="{id: 'item_datagrid'}" lay-filter="itemTableFilter"></table>
        </div>
    </div>
</div>

<!--dict model-->
<div id="dict_model" class="page_model" style="display:none;">
    <div class="layui-show">
        <div class="layui-form layui-form-pane">
            <form id="role_form" method="post" style="padding: 5px; line-height: 5px;">

                <div class="layui-form-item ">
                    <label  class="layui-form-label" >字典编码<span style="color: red">*</span></label>
                    <div class="layui-input-block">
                        <input type="text" id="dict_code" name="dict_code" required lay-verify="required" autocomplete="off" placeholder="请输入字典编码" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item ">
                    <label  class="layui-form-label" >字典名称<span style="color: red">*</span></label>
                    <div class="layui-input-block">
                        <input type="text" id="dict_name" name="dict_name" required lay-verify="required" autocomplete="off" placeholder="请输入字典名称" class="layui-input">
                    </div>
                </div>

                <div class="layui-form-item ">
                    <label class="layui-form-label" >字典状态</label>
                    <div class="layui-input-block">
                        <select id="dict_status" name="dict_status">
                            <option value="1" selected>正常</option>
                            <option value="0" >禁用</option>
                        </select>
                    </div>
                </div>
                <div class="layui-form-item layui-form-text">
                    <label class="layui-form-label" >字典描述</label>
                    <div class="layui-input-block">
                        <textarea id="dict_remark" name="dict_remark" placeholder="请输入字典描述" class="layui-textarea"></textarea>
                    </div>
                </div>
           <!--     <div class="layui-form-item" align="right">
                    <button class="layui-btn" id="addDict_btn" lay-filter="add_dict" lay-submit>确定</button>
                    <button class="layui-btn" id="editDict_btn" lay-filter="edit_dict" lay-submit>修改</button>
                </div>  -->
                <div class="layui-form-item page-form-btn">
                    <button class="layui-btn" id="form_submit_btn" lay-filter="form_submit_btn" lay-submit>确定</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!--item model-->
<div id="item_model" class="page_model" style="display:none;">
    <div class="layui-show">
        <div class="layui-form layui-form-pane">
            <form id="role_form" method="post" style="padding: 5px; line-height: 5px;">
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label  class="layui-form-label" >所属字典</label>
                        <div class="layui-input-inline">
                            <input type="text" id="dict_item_name" name="dict_item_name" autocomplete="off" placeholder="请输入字典编码" class="layui-input" disabled>
                        </div>
                    </div>
                    <div class="layui-inline" style="display: none">
                        <label  class="layui-form-label" >所属字典</label>
                        <div class="layui-input-inline">
                            <input type="text" id="dict_id" name="dict_id" autocomplete="off" placeholder="请输入字典编码" class="layui-input">
                        </div>
                    </div>


                    <div class="layui-inline">
                        <label class="layui-form-label">上级属性<span style="color:red">*</span></label>
                        <div class="layui-input-inline">
                            <div class="layui-unselect layui-form-select downpanel" >
                                <div class="layui-select-title" onclick="openSelectTree()">
                                    <span class="layui-input layui-unselect" ></span>
                                    <input type="hidden" name="item_parent_id" id="item_parent_id">
                                    <input type="hidden" name="item_parent_value" id="item_parent_value">
                                    <i class="layui-edge"></i>
                                </div>
                                <dl class="layui-anim layui-anim-upbit">
                                    <dd>
                                        <ul id="itemparentselecttree"></ul>
                                    </dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label  class="layui-form-label" >属性名<span style="color: red">*</span></label>
                        <div class="layui-input-inline">
                            <input type="text" id="item_text" name="item_text" required lay-verify="required" autocomplete="off" placeholder="请输入属性名" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label  class="layui-form-label" >属性值<span style="color: red">*</span></label>
                        <div class="layui-input-inline">
                            <input type="text" id="item_value" name="item_value" required lay-verify="required" autocomplete="off" placeholder="请输入属性值" class="layui-input">
                        </div>
                    </div>
                </div>

                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label  class="layui-form-label" >属性分组</label>
                        <div class="layui-input-inline">
                            <input type="text" id="item_type" name="item_type" autocomplete="off" placeholder="请输入属性分组" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label  class="layui-form-label" >排序号<span style="color:red">*</span></label>
                        <div class="layui-input-inline">
                            <input type="number" id="item_sort" name="item_sort" required lay-verify="required" autocomplete="off" value="1" class="layui-input">
                        </div>
                    </div>
                </div>

                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label  class="layui-form-label" >是否选中</label>
                        <div class="layui-input-inline">
                            <select id="item_checked" name="item_checked">
                                <option value="0" selected>否</option>
                                <option value="1" >是</option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label  class="layui-form-label" >状态</label>
                        <div class="layui-input-inline">
                            <select id="item_status" name="item_status">
                                <option value="1" selected>正常</option>
                                <option value="0" >禁用</option>
                            </select>
                        </div>
                    </div>
                </div>



                <div class="layui-form-item layui-form-text">
                    <label class="layui-form-label">属性描述</label>
                    <div class="layui-input-block">
                        <textarea id="item_remark" name="item_remark" placeholder="请输入属性描述" class="layui-textarea"></textarea>
                    </div>
                </div>
                <div class="layui-form-item page-form-btn">
                    <button class="layui-btn" id="form_submit_btn2" lay-filter="form_submit_btn2" lay-submit>确定</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script type="text/html" id="statusTpl">
    {{#out '{{d.dict_status == 1 ? "正常" : "禁用"}}'}}{{/out}}
</script>
<script type="text/html" id="itemStatusTpl">
    {{#out '{{d.item_status == 1 ? "正常" : "禁用"}}'}}{{/out}}
</script>
<script type="text/html" id="itemCheckStatusTpl">
    {{#out '{{d.item_checked == 1 ? "是" : "否"}}'}}{{/out}}
</script>


<script>

    layui.use(['table','form','jquery','tree','layer'], function(){
        var table = layui.table;
        var form = layui.form;
        var $ = layui.$;
        var layer=layui.layer;
        table.render({
            elem: '#dict_datagrid'
            ,id: 'dict_datagrid'
            ,url:'{{projcfg.base}}/dict/list.do'
            ,height: '{{projcfg.page_config.height}}'
            //,cellMinWidth: 10 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
            ,cols: [[
                {type:'numbers'},
                {type:'checkbox'},
                {field:'dict_code', title: '字典编码',align:'left'}
                ,{field:'dict_name', title: '字典名称',align:'left'}
                ,{field:'dict_status', title: '状态',width:100,toolbar: '#statusTpl',align:'left'}
            ]]
            ,page: true
            ,done: function(res, curr, count) {
                signleSelect($, 'dict_datagrid');
            }

        });
        table.render({
            elem: '#item_datagrid'
            ,id: 'item_datagrid'
            ,height: '{{projcfg.page_config.height}}'
            //,url:'{{projcfg.base}}/dict/item/list.do'
            //,cellMinWidth: 10 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
            ,cols: [[
                {type:'numbers'},
                {type:'checkbox'},
                {field:'item_type', title: '分组',align:'left'}
                ,{field:'item_text', title: '字段名',align:'left'}
                ,{field:'item_value', title: '字段值',align:'left'}
                ,{field:'item_checked', title: '默认选中',width:100,toolbar: '#itemCheckStatusTpl',align:'left'}
                ,{field:'item_sort', title: '排序号',width:80,align:'left'}
                ,{field:'item_status', title: '状态',width:80,toolbar: '#itemStatusTpl',align:'left'}
            ]]
            ,page: true
            ,text:{
                none:'请选择一个字典'
            }
            ,done: function(res, curr, count) {
                signleSelect($, 'item_datagrid');
            }

        });

        //字典复选框事件
        table.on('checkbox(dictTableFilter)',function (obj) {
            var dict_data=obj.data;
            console.log("id",dict_data);
            if(obj.checked){
                table.reload('item_datagrid',{
                    url: '{{projcfg.base}}/dict/dictitem/list.do',
                    where:{dict_id:dict_data.dict_id}
                });

                $('#item_parent_id').val('');
                $('#item_parent_value').val('');

                refreshtree(dict_data.dict_name,dict_data.dict_id);

            }
        })

        function refreshtree(dict_name,dict_id) {
            $.ajax({
                url:'{{projcfg.base}}/dict/itemtree.do',
                type:'get',
                data:{'dictname':dict_name,'dictid':dict_id},
                success:function (res) {
                    $('#itemparentselecttree').empty();
                    layui.tree({
                        elem:'#itemparentselecttree',
                        nodes:JSON.parse(res.data),
                        click:function (node) {
                            console.log('node',node);
                            if(node.id==0){
                                // console.log('root');
                                $('#item_parent_id').val(0);
                                $('#item_parent_value').val('');
                            }else{
                                $('#item_parent_id').val(node.id);
                                $('#item_parent_value').val(node.value);
                                // console.log('not root');
                            }
                            var $select=$($(this)[0].elem).parents(".layui-form-select");
                            $select.removeClass("layui-form-selected").find(".layui-select-title span").html(node.name);
                        }
                    });
                }
            });
        }

        /*$(".downpanel").on("click",".layui-select-title",function(e) {
            $(".layui-form-select").not($(this).parents(".layui-form-select")).removeClass("layui-form-selected");
            $(this).parents(".downpanel").toggleClass("layui-form-selected");
            layui.stope(e);
        }).on("click","dl i",function(e) {
            layui.stope(e);
        });*/

        //监听锁定操作
        form.on('checkbox(lock)', function(obj){
            console.log(obj);
            layer.tips(this.value + ' ' + this.name + '：'+ obj.elem.checked, obj.othis);
            var account_status='';

            var account_name= this.value;
            if(obj.elem.checked){
                account_status = 2;
            }else {
                account_status = 1;
            }
            var loading = layer.load(1);
            $.ajax({
                url: "{{projcfg.base}}/admin/lock.json",
                data: {account_name:account_name,account_status:account_status},
                method: 'POST',
                success: function (res) {

                    if (res.success) {
                        layer.close(loading);
                        layer.msg(res.msg, {icon: 6, time: 2000}, function () {

                        });
                    }
                    else {
                        layer.close(loading);
                        layer.msg(res.msg, {icon: 5});
                    }
                },
                error: function () {
                    layer.close(loading);
                    layer.msg("设置账号禁用状态失败", {icon: 5});
                }
            });
        });
        

        //新增字典
        $(".dictAdd_btn").click(function(){
            openLayer(layui.layer, {
                title: '新增字典',     //显示标题
                area: ['500px', '400px'], //宽高
                content:  $('#dict_model'),
                success: function(layero, index){
                    form.render();

                    //监听提交
                    form.on('submit(form_submit_btn)', function(data){

                        var loading = layer.load(1);
                        $.ajax({
                            url: "{{projcfg.base}}/dict/save.do",
                            data: data.field, //请求的附加参数，用json对象
                            method: 'POST',
                            success: function (res) {
                                if(res.success) {
                                    layer.close(loading);
                                    layer.closeAll();
                                    layer.msg(res.msg, { icon: 6, time: 2000 }, function () {
                                        table.reload('dict_datagrid',{
                                            url: '{{projcfg.base}}/dict/list.do'
                                        });
                                    });
                                }
                                else {
                                    layer.close(loading);
                                    layer.msg(res.msg, { icon: 5 });
                                }
                            },
                            error: function () {
                                layer.close(loading);
                                layer.msg("新建字典失败", { icon: 5 });
                            }
                        });

                        return false;
                    });
                }
            }, '#form_submit_btn');
        });

        //新增属性
        $(".itemAdd_btn").click(function(){

            var checkStatus = table.checkStatus('dict_datagrid');
            var dictdata=checkStatus.data;
            if (checkStatus.data.length != 1) {
                layer.msg("请先在左侧字典列表选择一个字典。", {icon: 5});
            }else{

                openLayer(layui.layer, {
                    title: '新增字典属性',     //显示标题
                    area: ['680px', '450px'], //宽高
                    content:  $('#item_model'),
                    success: function(layero, index){
                        form.render();

                        $('#dict_item_name').val(dictdata[0].dict_name);
                        $('#dict_id').val(dictdata[0].dict_id);
                        $('#item_parent_id').val(0);
                        $(".layui-select-title span").html(dictdata[0].dict_name);

                        //监听提交
                        form.on('submit(form_submit_btn2)', function(data){
                            var loading = layer.load(1);
                            $.ajax({
                                url: "{{projcfg.base}}/dict/item/save.do",
                                data: data.field, //请求的附加参数，用json对象
                                method: 'POST',
                                success: function (res) {
                                    if(res.success) {
                                        layer.close(loading);
                                        layer.closeAll();
                                        layer.msg(res.msg, { icon: 6, time: 2000 }, function () {
                                            $(".layui-select-title span").html('');
                                            clear(data.field);
                                            //刷新树
                                            refreshtree(dictdata[0].dict_name,dictdata[0].dict_id);
                                            table.reload('item_datagrid',{
                                                url: '{{projcfg.base}}/dict/dictitem/list.do',
                                                where:{dict_id:dictdata[0].dict_id}
                                            });
                                        });
                                    }
                                    else {
                                        layer.close(loading);
                                        layer.msg(res.msg, { icon: 5 });
                                    }
                                },
                                error: function () {
                                    layer.close(loading);
                                    layer.msg("新建字典失败", { icon: 5 });
                                }
                            });

                            return false;
                        });
                    }
                }, '#form_submit_btn2');
            }
        });

        //edit dict
        $(".dictEdit_btn").click(function () {
            var checkStatus = table.checkStatus('dict_datagrid');
            if (checkStatus.data.length != 1) {
                layer.msg("请选择一条数据。", {icon: 5});
            }else{

                var dictdata=checkStatus.data;
                openLayer(layui.layer, {
                    title: '修改字典',     //显示标题
                    area: ['500px', '400px'], //宽高
                    content:  $('#dict_model'),
                    btn2: function(index, layero){
                        clear(dictdata[0]);
                        layer.close(index);
                    },
                    cancel:function (index,layero) {
                        clear(dictdata[0]);
                        layer.close(index);
                    },
                    // 窗口加载成功后调用
                    success: function(layero, index) {

                        getData(dictdata[0]);
                        form.on('submit(form_submit_btn)',function (data) {
                            data.field.dict_id=dictdata[0].dict_id;
                            var loading=layer.load(1);
                            $.ajax({
                                url: "{{projcfg.base}}/dict/modify.do",
                                data: data.field, //请求的附加参数，用json对象
                                method: 'POST',
                                success:function (res) {
                                    if(res.success) {
                                        layer.close(loading);
                                        layer.closeAll();
                                        layer.msg(res.msg, { icon: 6, time: 2000 }, function () {
                                            clear(dictdata[0]);
                                            table.reload('dict_datagrid',{
                                                url: '{{projcfg.base}}/dict/list.do'
                                            });
                                        });
                                    }
                                    else {
                                        layer.close(loading);
                                        layer.msg(res.msg, { icon: 5 });
                                    }
                                },
                                error: function () {
                                    layer.close(loading);
                                    layer.msg("修改字典信息失败", { icon: 5 });
                                }
                            });
                            return false;
                        });
                    }
                }, '#form_submit_btn');
            }
        });

        //edit item
        $(".itemEdit_btn").click(function () {

            var dictcheckStatus = table.checkStatus('dict_datagrid');
            if (dictcheckStatus.data.length != 1) {
                layer.msg("请先在左侧字典列表选择一个字典。", {icon: 5});
            }else {
                var checkStatus = table.checkStatus('item_datagrid');
                if (checkStatus.data.length != 1) {
                    layer.msg("请选择一条属性。", {icon: 5});
                } else {
                    var dictdata = dictcheckStatus.data;
                    var itemdata = checkStatus.data;
                    openLayer(layui.layer, {
                        title: '修改属性',     //显示标题
                        area: ['680px', '450px'], //宽高
                        content: $('#item_model'),
                        btn2: function(index, layero){
                            $(".layui-select-title span").html('');
                            clear(itemdata[0]);
                            layer.close(index);
                        },
                        cancel: function (index, layero) {
                            $(".layui-select-title span").html('');
                            clear(itemdata[0]);
                            layer.close(index);
                        },
                        // 窗口加载成功后调用
                        success: function (layero, index) {

                            $('#dict_item_name').val(dictdata[0].dict_name);
                            $('#dict_id').val(dictdata[0].dict_id);
                            var currentDictItems = table.cache.item_datagrid;

                            if (itemdata[0].item_parent_id == 0) {
                                $(".layui-select-title span").html(dictdata[0].dict_name);
                            } else {
                                var currentDictItems = table.cache.item_datagrid;
                                for (var i in currentDictItems) {
                                    if (currentDictItems[i].item_id == itemdata[0].item_parent_id) {
                                        $(".layui-select-title span").html(currentDictItems[i].item_text);
                                        break;
                                    }
                                }
                            }
                            getData(itemdata[0]);
                            form.on('submit(form_submit_btn2)', function (data) {
                                data.field.item_id = itemdata[0].item_id;
                                var loading = layer.load(1);
                                $.ajax({
                                    url: "{{projcfg.base}}/dict/item/modify.do",
                                    data: data.field, //请求的附加参数，用json对象
                                    method: 'POST',
                                    success: function (res) {
                                        if (res.success) {
                                            layer.close(loading);
                                            layer.closeAll();
                                            layer.msg(res.msg, {icon: 6, time: 2000}, function () {
                                                $(".layui-select-title span").html('');
                                                clear(itemdata[0]);
                                                //刷新树
                                                refreshtree(dictdata[0].dict_name, dictdata[0].dict_id);
                                                table.reload('item_datagrid', {
                                                    url: '{{projcfg.base}}/dict/dictitem/list.do',
                                                    where: {dict_id: dictdata[0].dict_id}
                                                });
                                            });
                                        }
                                        else {
                                            layer.close(loading);
                                            layer.msg(res.msg, {icon: 5});
                                        }
                                    },
                                    error: function () {
                                        layer.close(loading);
                                        layer.msg("修改属性信息失败", {icon: 5});
                                    }
                                });
                                return false;
                            });
                        }
                    }, '#form_submit_btn2');
                }
            }
        });

        //修改角色信息弹窗回填
        function getData(data) {
            for(var k in data){
                $('#'+k).val(data[k]);
            }
            form.render();
        }

        //清空表单
        function clear(data) {
            for(var k in data){
                $('#'+k).val('');
            }
            form.render();
        }

        //查询字典
        $(".searchDict_btn").click(function(){

            var dict_name = $(".searchDict_input").val();
            if($(".searchDict_input").val() != ''){

                table.reload('dict_datagrid',{
                    where: { //设定异步数据接口的额外参数，任意设
                        dict_name:dict_name
                    },
                    page: {
                        curr: 1 //重新从第 1 页开始
                    }
                });
            }else{
                layer.msg("请输入需要查询的内容");
            }
        })
        //查询字典属性
        $(".searchItem_btn").click(function(){

            var item_name = $(".searchItem_input").val();
            if($(".searchItem_input").val() != ''){

                table.reload('item_datagrid',{
                    where: { //设定异步数据接口的额外参数，任意设
                        item_name:item_name
                    },
                    page: {
                        curr: 1 //重新从第 1 页开始
                    }
                });
            }else{
                layer.msg("请输入需要查询的内容");
            }
        })
        //重置字典
        $(".restDict_btn").click(function(){

            $(".searchDict_input").val("");
            table.reload('dict_datagrid',{
                where: { //设定异步数据接口的额外参数，任意设
                    dict_name:'',
                },
                page: {
                    curr: 1 //重新从第 1 页开始
                }
            });
        })
        //重置字典属性
        $(".restItem_btn").click(function(){

            $(".searchItem_input").val("");
            table.reload('item_datagrid',{
                where: { //设定异步数据接口的额外参数，任意设
                    dict_name:'',
                },
                page: {
                    curr: 1 //重新从第 1 页开始
                }
            });
        })
    });


</script>