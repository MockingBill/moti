<div class="layui-row">
    <div class="layui-col-md2">
        <div>
            <ul id="org_tree" lay-filter="orgtreefilter"></ul>
        </div>
    </div>
    <div class="layui-col-md10">
        <blockquote class="layui-elem-quote news_search">
            <div class="layui-inline">
                <div class="layui-input-inline">
                    <input type="text" value="" placeholder="请输入机构编码/名称" class="layui-input search_input">
                </div>
                <a class="layui-btn layui-btn-primary search_btn"><i class="layui-icon">&#xe615;</i>查询</a>
            </div>
            <div class="layui-inline">

                <a class="layui-btn layui-btn-primary rest_btn"><i class="layui-icon">&#xe65c;</i>重置</a>
            </div>
            <div class="layui-inline">
                <a class="layui-btn layui-btn-primary newsAdd_btn"><i class="layui-icon">&#xe654;</i>新增</a>
            </div>
            <div class="layui-inline">
                <a class="layui-btn layui-btn-primary Edit_btn"><i class="layui-icon">&#xe642;</i>修改</a>
            </div>
            <div class="layui-inline">
                <div class="layui-form-mid layui-word-aux"></div>
            </div>
        </blockquote>
        <div class="layui-form news_list">
            <table class="layui-hide" id="datagrid" lay-data="{id: 'datagrid'}" lay-size="sm" lay-filter="TableFilter"></table>
        </div>
    </div>
</div>



<!-- Modal -->
<div id="org_model" class="page_model" style="display:none;">
    <div class="layui-show">
        <div class="layui-form layui-form-pane">
            <form method="post" id="orgForm" style="padding: 5px; line-height: 5px;">
                <div class="layui-form-item">
                    <label class="layui-form-label">上级机构<span style="color:red">*</span></label>
                    <div class="layui-input-block">
                        <div class="layui-unselect layui-form-select downpanel">
                            <div class="layui-select-title"  onclick="openSelectTree()">
                                <span class="layui-input layui-unselect" id="treeclass" ></span>
                                <input type="hidden" name="org_parent_id" id="org_parent_id">
                                <i class="layui-edge"></i>
                            </div>
                            <dl class="layui-anim layui-anim-upbit">
                                <dd>
                                    <ul id="classtree"></ul>
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label for="L_orgcode" class="layui-form-label">机构编码<span style="color:red">*</span></label>
                    <div class="layui-input-block">
                        <input type="text" id="org_code" name="org_code" required lay-verify="required" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label for="L_orgname" class="layui-form-label">机构名称<span style="color:red">*</span></label>
                    <div class="layui-input-block">
                        <input type="text" id="org_name" name="org_name" required lay-verify="required" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label for="L_sysurl" class="layui-form-label">机构全称<span style="color:red">*</span></label>
                    <div class="layui-input-block">
                        <input type="text" id="org_full_name" name="org_full_name" required lay-verify="required" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label for="L_sys_mainrul" class="layui-form-label">机构类别<span style="color:red">*</span></label>
                        <div class="layui-input-inline">
                            <input name="org_type" readonly="readonly" value="1" id="org_type"  required lay-verify="required" autocomplete="off" class="layui-input">
                            </input>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label  class="layui-form-label" >所在地区<span style="color:red">*</span></label>
                        <div class="layui-input-inline">
                            <select name="org_area_id" id="org_area_id" required lay-verify="required" lay-filter="orgList">
                                <option value="" ></option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label  class="layui-form-label" >排序号</label>
                        <div class="layui-input-inline">
                            <input type="number" id="org_sort" name="org_sort" autocomplete="off" value="1" class="layui-input" >
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">状态</label>
                        <div class="layui-input-inline">
                            <select name="org_status" id="org_status">
                                <option value="1" >启用</option>
                                <option value="0" >禁用</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="layui-form-item layui-form-text">
                    <label for="L_sysremark" class="layui-form-label">备注</label>
                    <div class="layui-input-block">
                        <textarea id="org_remark" name="org_remark" placeholder="请输入备注" class="layui-textarea" rows="2"></textarea>
                    </div>
                </div>
                <div class="layui-form-item page-form-btn">
                    <button class="layui-btn" id="form_submit_btn" lay-filter="form_submit_btn" lay-submit>确定</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!--tree model-->
<div id="treeModel" style="display: none">
    <div style="overflow: auto;">
        <ul id="orgParentTree" lay-filter="orgtreefilter"></ul>
    </div>
</div>


<script type="text/html" id="optTpl">
    <a class="layui-btn layui-btn-xs" lay-event="Edit">编辑</a>
</script>

<script type="text/html" id="statusTpl">
        {{#out '{{d.org_status == 1 ? "启用" : "禁用"}}'}}{{/out}}
</script>

<script>

    layui.use(['table','form','jquery','tree'], function(){
        var table = layui.table;
        var form = layui.form;
        var $ = layui.$;

        //树
        $.ajax({
            url:"{{projcfg.base}}/org/tree.do",
            method :'get',
            success:function (res) {
                //console.log('res = ',res.data);
                layui.tree({
                    elem:'#org_tree',
                    nodes:JSON.parse(res.data),
                    click:function (node) {
                        //console.log("dianji",node.id);
                        table.reload('datagrid',{
                            url: '{{projcfg.base}}/org/clickTree.do',
                            where:{org_id:node.id}
                        });
                    }
                });
            }
        });

        //机构父亲目录初始化
        $.ajax({
            url:'{{projcfg.base}}/org/tree.do',
            type:'get',
            //data:{'sysname':sys_name,'sysid':sys_id},
            success:function (res) {
                layui.tree({
                    elem:'#classtree',
                    nodes:JSON.parse(res.data),
                    click:function (node) {
                        $('#org_parent_id').val(node.id);
                        var $select=$($(this)[0].elem).parents(".layui-form-select");
                        $select.removeClass("layui-form-selected").find(".layui-select-title span").html(node.name);
                    }
                });
            }
        });

        /*$(".downpanel").on("click",".layui-select-title",function(e) {
            $(".layui-form-select").not($(this).parents(".layui-form-select")).removeClass("layui-form-selected");
            $(this).parents(".downpanel").toggleClass("layui-form-selected");
            layui.stope(e);
        }).on("click","dl i",function(e) {
            layui.stope(e);
        });*/

        //表
        table.render({
            elem: '#datagrid'
            ,id: 'datagrid'
            ,url:'{{projcfg.base}}/org/list.do'
            ,height: '{{projcfg.page_config.height}}'
            //,cellMinWidth: 10 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
            ,cols: [[
                {type:'numbers'},
                {type:'checkbox'},
                {field:'org_code', title: '机构编码',width:120,align:'left'}
                ,{field:'org_name', title: '机构名称',align:'left'}
                ,{field:'org_full_name', title: '机构全称',align:'left'}
                ,{field:'area_full_name', title: '所在地区',width:120,align:'left'}
                ,{field:'org_type_name', title: '机构类型',width:120,align:'left'}
                ,{field:'org_status', title: '状态',width:120,toolbar: '#statusTpl',align:'left'}
                //,{field:'account_opt', title: '操作',width:170,toolbar: '#optTpl',align:'left'}
            ]]
            ,page: true
            ,done: function(res, curr, count) {
                signleSelect($, 'datagrid');
            }
        });


        //获取组织列表
        $.ajax({
            url:'{{projcfg.base}}/org/orglist.do',
            type:'get',
            success:function (res) {
                $('#org_parent_id').html('');
                var items=res.data;
                for(var i in items){
                    //console.log(items[i].org_id);
                    $('#org_parent_id').append('<option value =\"' + items[i].org_id + '\">' + items[i].org_name + '</option>');
                    form.render('select');
                }
                //$('#org_parent_id').get(0).selectedIndex=0;
            }
        });

        //获取机构类别列表
        $.ajax({
            url:'{{projcfg.base}}/org/orgstyle.do',
            type:'get',
            success:function (res) {
                $('#org_type').html('');
                var items=res.data;
                //console.log(items);
                for(var i in items){
                    $('#org_type').append('<option value =\"' + items[i].item_value + '\">' + items[i].item_text + '</option>');
                    form.render('select');
                }
                //$('#org_type').get(0).selectedIndex=0;
            }
        });

        //获取机构地区列表
        $.ajax({
            url:'{{projcfg.base}}/org/orgarea.do',
            type:'get',
            success:function (res) {
                $('#org_area_id').html('');
                var items=res.data;
                //console.log(items);
                for(var i in items){
                    $('#org_area_id').append('<option value =\"' + items[i].area_id + '\">' + items[i].area_name + '</option>');
                    form.render('select');
                }
                //$('#org_area_id').get(0).selectedIndex=0;
            }
        });


        //新增
        $(".newsAdd_btn").click(function(){
            openLayer(layui.layer, {
                title: '新增机构',     //显示标题
                area: ['750px', '550px'], //宽高
                content:  $('#org_model'),
                success: function(layero, index){
                    form.render();

                    //监听提交
                    form.on('submit(form_submit_btn)', function(data){
                        console.log(data);

                        var loading = layer.load(1);
                        $.ajax({
                            url: "{{projcfg.base}}/org/save.do",
                            data: data.field, //请求的附加参数，用json对象
                            method: 'POST',
                            success: function (res) {
                                //alert(res);
                                if(res.success) {
                                    layer.close(loading);
                                    layer.closeAll();
                                    layer.msg(res.msg, { icon: 6, time: 2000 }, function () {
                                        reload();
                                    });
                                }
                                else {
                                    layer.close(loading);
                                    layer.msg(res.msg, { icon: 5 });
                                }
                            },
                            error: function () {
                                layer.close(loading);
                                layer.msg("新建机构失败", { icon: 5 });
                            }
                        });

                        return false;
                    });
                }
            }, '#form_submit_btn');

        })

        $(".orgTreeModel").click(function () {
            layer.open({
                type:1,
                title:'上级机构',
                closeBtn:1,
                area:['500px','500px'],
                content:$('#treeModel')
            })
        })


        $(".Edit_btn").click(function () {
            /*$('#add_btn').hide();
            $('#edit_btn').show();*/
            var checkStatus = table.checkStatus('datagrid');
            if (checkStatus.data.length != 1) {
                layer.msg("请选择一条数据。", {icon: 5});
            } else {
                var orgdata = checkStatus.data;

                openLayer(layui.layer, {
                    title: '修改机构',
                    area: ['750px', '550px'], //宽高
                    content: $('#org_model'),
                    btn2: function(index, layero){
                        $(".layui-select-title span").html('');
                        clear(orgdata[0]);
                        layer.close(index);
                    },
                    cancel: function (index, layero) {
                        $(".layui-select-title span").html('');
                        clear(orgdata[0]);
                        layer.close(index);
                    },
                    // 窗口加载成功后调用
                    success: function(layero, index) {

                        getdata(orgdata[0])//编辑

                        //监听提交
                        form.on('submit(form_submit_btn)', function (formdata) {
                            formdata.field.org_id = orgdata[0].org_id
                            var loading = layer.load(1);
                            $.ajax({
                                url: "{{projcfg.base}}/org/modify.do",
                                data: formdata.field, //请求的附加参数，用json对象
                                method: 'POST',
                                success: function (res) {
                                    //alert(res);
                                    if (res.success) {
                                        layer.close(loading);
                                        layer.closeAll();
                                        layer.msg(res.msg, {icon: 6, time: 2000}, function () {
                                            location.reload();
                                        });
                                    }
                                    else {
                                        layer.close(loading);
                                        layer.msg(res.msg, {icon: 5});
                                    }
                                },
                                error: function () {
                                    layer.close(loading);
                                    layer.msg("修改失败", {icon: 5});
                                }
                            });
                            return false;
                        });
                    }
                }, '#form_submit_btn');
            }
        })


        //弹窗回填
        function getdata(data) {
            //获取上级机构
            $.ajax({
                url:'{{projcfg.base}}/org/parentname.do',
                type:'POST',
                data: {org_parent_id:data.org_parent_id},
                success:function (res) {
                    for (var k in res){
                        $(".layui-select-title span").html(res[k].org_name);
                    }
                    }
                });


            //其他信息回填
            for(var k in data){
                $('#'+k).val(data[k]);
            }
            form.render();
        }

        //清除弹窗
        function clear(data) {
            for(var k in data){
                $('#'+k).val('');
            }
            form.render();
        }


        function reload() {
            table.reload('datagrid', {

            });
        }


        //查询
        $(".search_btn").click(function(){

            var org_name = $(".search_input").val();
            if($(".search_input").val() != ''){

                table.reload('datagrid',{
                    where: { //设定异步数据接口的额外参数，任意设
                        org_name:org_name
                    },
                    page: {
                        curr: 1 //重新从第 1 页开始
                    }
                });
            }else{
                layer.msg("请输入需要查询的内容");
            }
        })
        //重置
        $(".rest_btn").click(function(){

            $(".search_input").val("");
            table.reload('datagrid',{
                where: { //设定异步数据接口的额外参数，任意设
                    org_name:''
                },
                page: {
                    curr: 1 //重新从第 1 页开始
                }
            });
        })
    });

</script>